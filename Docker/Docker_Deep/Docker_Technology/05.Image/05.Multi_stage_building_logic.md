# Multi-Stage Building: The Complete Logic Explained Simply

## Table of Contents

1. [The Core Logic in Simple Terms](https://claude.ai/chat/1aeaf5cc-96d4-4c4b-bd25-c56339a51961#core-logic)
2. [The Real-World Analogy: Building a Car](https://claude.ai/chat/1aeaf5cc-96d4-4c4b-bd25-c56339a51961#car-analogy)
3. [Why Traditional Single-Stage is Wasteful](https://claude.ai/chat/1aeaf5cc-96d4-4c4b-bd25-c56339a51961#single-stage-problem)
4. [How Multi-Stage Solves the Problem](https://claude.ai/chat/1aeaf5cc-96d4-4c4b-bd25-c56339a51961#multi-stage-solution)
5. [The Logic Step by Step](https://claude.ai/chat/1aeaf5cc-96d4-4c4b-bd25-c56339a51961#step-by-step-logic)
6. [Memory and Deletion Logic](https://claude.ai/chat/1aeaf5cc-96d4-4c4b-bd25-c56339a51961#memory-logic)
7. [The "Copy" Magic Explained](https://claude.ai/chat/1aeaf5cc-96d4-4c4b-bd25-c56339a51961#copy-magic)
8. [Why Only the Last Stage is Kept](https://claude.ai/chat/1aeaf5cc-96d4-4c4b-bd25-c56339a51961#last-stage-logic)
9. [Complete Example with Logic Flow](https://claude.ai/chat/1aeaf5cc-96d4-4c4b-bd25-c56339a51961#complete-example)
10. [Common Questions About the Logic](https://claude.ai/chat/1aeaf5cc-96d4-4c4b-bd25-c56339a51961#common-questions)

---

## The Core Logic in Simple Terms {#core-logic}

Multi-stage building follows this simple logic:

```
THE FUNDAMENTAL LOGIC:

Step 1: Create a "workspace" with ALL the tools you need
        â†“
Step 2: Build/compile/create your product in that workspace
        â†“
Step 3: Create a NEW, empty workspace
        â†“
Step 4: Copy ONLY the finished product from old workspace to new workspace
        â†“
Step 5: Throw away the old workspace (with all the tools)
        â†“
Result: You only keep the finished product, not the tools!
```

**The Key Insight**: You don't need the hammer after you've built the house!

---

## The Real-World Analogy: Building a Car {#car-analogy}

Let me explain multi-stage building like you're building a car:

### Scenario: You Want to Build a Custom Car

**Single-Stage Building (The Wrong Way):**

```
Your Garage (Single Location):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    YOUR GARAGE                          â”‚
â”‚                                                         â”‚
â”‚  The Car (what you want)           2,000 lbs            â”‚
â”‚  â”œâ”€ Engine                                              â”‚
â”‚  â”œâ”€ Wheels                                              â”‚
â”‚  â””â”€ Body                                                â”‚
â”‚                                                         â”‚
â”‚  Manufacturing Equipment (needed to build)              â”‚
â”‚  â”œâ”€ Welding machines               5,000 lbs            â”‚
â”‚  â”œâ”€ Paint booth                    3,000 lbs            â”‚
â”‚  â”œâ”€ Engine assembly tools          2,000 lbs            â”‚
â”‚  â”œâ”€ Metal cutting machines         4,000 lbs            â”‚
â”‚  â””â”€ Testing equipment              2,000 lbs            â”‚
â”‚                                                         â”‚
â”‚  Raw Materials (used for building)                      â”‚
â”‚  â”œâ”€ Steel sheets                   3,000 lbs            â”‚
â”‚  â”œâ”€ Leftover paint                 500 lbs              â”‚
â”‚  â”œâ”€ Spare parts bin                1,000 lbs            â”‚
â”‚  â””â”€ Scrap metal                    2,000 lbs            â”‚
â”‚                                                         â”‚
â”‚  Building Plans & Blueprints       50 lbs               â”‚
â”‚                                                         â”‚
â”‚  TOTAL GARAGE WEIGHT: 24,550 lbs                        â”‚
â”‚  (You wanted a 2,000 lb car but got 24,550 lbs!)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Problem: You're keeping the car AND the entire factory!
```

**Multi-Stage Building (The Smart Way):**

```
STAGE 1: FACTORY (Temporary Location)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 MANUFACTURING FACTORY                   â”‚
â”‚  (This entire building will be demolished!)             â”‚
â”‚                                                         â”‚
â”‚  Manufacturing Equipment          16,000 lbs            â”‚
â”‚  â”œâ”€ Welding machines                                    â”‚
â”‚  â”œâ”€ Paint booth                                         â”‚
â”‚  â”œâ”€ Engine assembly tools                               â”‚
â”‚  â”œâ”€ Metal cutting machines                              â”‚
â”‚  â””â”€ Testing equipment                                   â”‚
â”‚                                                         â”‚
â”‚  Raw Materials                    6,500 lbs             â”‚
â”‚  â”œâ”€ Steel sheets                                        â”‚
â”‚  â”œâ”€ Paint                                               â”‚
â”‚  â”œâ”€ Spare parts                                         â”‚
â”‚  â””â”€ Scrap metal                                         â”‚
â”‚                                                         â”‚
â”‚  Building Plans                   50 lbs                â”‚
â”‚                                                         â”‚
â”‚  â¬‡ï¸ BUILD THE CAR â¬‡ï¸                                   â”‚
â”‚  â¬‡ï¸ USE ALL TOOLS â¬‡ï¸                                   â”‚
â”‚  â¬‡ï¸ WELD, PAINT, ASSEMBLE â¬‡ï¸                           â”‚
â”‚                                                         â”‚
â”‚  Finished Car âœ“                   2,000 lbs             â”‚
â”‚  â”œâ”€ Engine âœ“                                            â”‚
â”‚  â”œâ”€ Wheels âœ“                                            â”‚
â”‚  â””â”€ Body âœ“                                              â”‚
â”‚                                                         â”‚
â”‚  TOTAL FACTORY WEIGHT: 24,550 lbs                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ Drive ONLY the finished car out â¬‡ï¸
        â”‚
        â–¼
STAGE 2: YOUR GARAGE (Final Location)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    YOUR GARAGE                          â”‚
â”‚                                                         â”‚
â”‚  The Car âœ“                        2,000 lbs             â”‚
â”‚  â”œâ”€ Engine âœ“                                            â”‚
â”‚  â”œâ”€ Wheels âœ“                                            â”‚
â”‚  â””â”€ Body âœ“                                              â”‚
â”‚                                                         â”‚
â”‚  TOTAL GARAGE WEIGHT: 2,000 lbs âœ“                       â”‚
â”‚  (Perfect! Only what you need!)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Meanwhile: Factory demolished ğŸ—‘ï¸ (24,550 lbs freed!)

Result: You have the car, factory is gone!
```

### The Key Logic Points:

1. **Two Separate Locations**: Factory (stage 1) and Garage (stage 2)
2. **Build in Factory**: Use all the heavy tools there
3. **Transfer Only Product**: Move only the finished car
4. **Demolish Factory**: Get rid of all the tools and waste
5. **Keep Only Garage**: Final location with only the car

This is EXACTLY how Docker multi-stage builds work!

---

## Why Traditional Single-Stage is Wasteful {#single-stage-problem}

Let's understand the logic of WHY single-stage is bad:

### The Problem Logic Chain

```
SINGLE-STAGE LOGIC FLOW:

1. Start with base image
   â””â”€ Contains: Operating system + tools
   
2. Install build tools
   â””â”€ Add: Compilers, build systems, dev tools
   
3. Copy source code
   â””â”€ Add: Your application source files
   
4. Install dependencies
   â””â”€ Add: ALL packages (production + development)
   
5. Build/compile application
   â””â”€ Add: Compiled output
   
6. Set start command
   â””â”€ Image is now "complete"

RESULT: Everything from steps 1-6 stays in final image!
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: Base OS          200 MB             â”‚  Still here âœ“
â”‚ Step 2: Build tools      300 MB             â”‚  Still here âš ï¸
â”‚ Step 3: Source code      20 MB              â”‚  Still here âš ï¸
â”‚ Step 4: Dependencies     500 MB             â”‚  Still here âš ï¸
â”‚ Step 5: Built output     5 MB               â”‚  Still here âœ“
â”‚ Step 6: Command          0 MB               â”‚  Still here âœ“
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ TOTAL                    1,025 MB           â”‚
â”‚ Actually needed          205 MB             â”‚
â”‚ Waste                    820 MB (80%!)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

WHY IS THIS BAD?
- You need build tools to BUILD, not to RUN
- Source code is not needed after compilation
- Dev dependencies are not needed in production
- But they all stay in the image forever!
```

### The Storage Logic Problem

```
HOW DOCKER STORES LAYERS (The Problem):

Each command creates a layer that NEVER disappears:

Command 1: RUN install build-tools
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 1: build-tools (300 MB)   â”‚ â† SEALED FOREVER
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Command 2: RUN delete build-tools
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 2: "delete marker" (4 KB) â”‚ â† Just a marker, doesn't remove Layer 1!
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

RESULT: 
You see: No build tools (deleted)
Reality: 300 MB still in Layer 1 on disk!

THIS IS WHY DELETING FILES DOESN'T REDUCE IMAGE SIZE!
```

The logic: Once a layer is created, it's permanent. Deletion just hides files, doesn't remove them.

---

## How Multi-Stage Solves the Problem {#multi-stage-solution}

Now let's understand the LOGIC of how multi-stage fixes this:

### The Multi-Stage Logic Chain

```
MULTI-STAGE LOGIC FLOW:

STAGE 1 (Builder Stage):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Start with build-focused base image
   â””â”€ Contains: OS + all development tools
   
2. Copy source code
   â””â”€ Add: Your application source
   
3. Install ALL dependencies
   â””â”€ Add: Production + development packages
   
4. Build/compile application
   â””â”€ Create: Compiled output
   
5. Stage 1 Complete
   â””â”€ Total size: 1,025 MB
   â””â”€ Status: TEMPORARY (will be deleted)

STAGE 2 (Production Stage):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Start FRESH with minimal base image
   â””â”€ Contains: Only minimal OS + runtime
   
2. Install ONLY production dependencies
   â””â”€ Add: Only packages needed to run
   
3. COPY ONLY built output from Stage 1
   â””â”€ Take: Just the 5 MB of compiled code
   
4. Set start command
   â””â”€ Image is now "complete"
   
5. Stage 2 Complete
   â””â”€ Total size: 205 MB
   â””â”€ Status: FINAL (this is kept)

DELETE STAGE 1:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Stage 1 with all its 1,025 MB is thrown away ğŸ—‘ï¸

FINAL RESULT: Only Stage 2 (205 MB) is saved
```

### The Key Logic Difference

```
SINGLE-STAGE LOGIC:
Everything accumulated â†’ Everything kept

MULTI-STAGE LOGIC:
Stage 1: Accumulate everything â†’ Delete entire stage
Stage 2: Start fresh â†’ Only copy what's needed â†’ Keep only this
```

---

## The Logic Step by Step {#step-by-step-logic}

Let me break down the EXACT logic of how multi-stage builds work:

### Step 1: Docker Reads the Dockerfile

```
Docker's Logic:
1. Read entire Dockerfile
2. Count how many FROM statements
3. Each FROM = One stage
4. Last FROM = Final stage (the one to keep)

Example Dockerfile:
FROM node:18 AS builder      â† Stage 1
FROM node:18-alpine          â† Stage 2 (Last, so this is final)

Docker's Decision:
- Stage 1: Temporary (will delete)
- Stage 2: Final (will keep)
```

### Step 2: Build Stage 1 (Builder)

```
DOCKER'S LOGIC FOR STAGE 1:

Read: FROM node:18 AS builder
Think: "This is stage 1, I'll call it 'builder'"
Do: 
  1. Pull node:18 image
  2. Load into memory (900 MB)
  3. Label as "builder"

Read: WORKDIR /app
Think: "Create directory in builder stage"
Do:
  1. Create /app directory
  2. Set as working directory
  3. Add to builder stage

Read: COPY package.json ./
Think: "Copy file into builder stage"
Do:
  1. Find package.json on host
  2. Copy to /app/ in builder stage
  3. Create new layer (50 KB)
  4. Add to builder stage

Read: RUN npm install
Think: "Execute command in builder stage"
Do:
  1. Run npm install
  2. Downloads packages (500 MB)
  3. Create new layer (500 MB)
  4. Add to builder stage

Read: COPY . .
Think: "Copy more files into builder stage"
Do:
  1. Copy all source files
  2. Create new layer (20 MB)
  3. Add to builder stage

Read: RUN npm run build
Think: "Execute build command in builder stage"
Do:
  1. Run webpack/TypeScript compiler
  2. Creates dist/ folder (5 MB)
  3. Create new layer (5 MB)
  4. Add to builder stage

Stage 1 Complete!
Total: 1,425 MB
Status: Temporary, keep in memory for now
```

### Step 3: Build Stage 2 (Production)

```
DOCKER'S LOGIC FOR STAGE 2:

Read: FROM node:18-alpine
Think: "This is stage 2, no name given, it's the final stage"
Do:
  1. Pull node:18-alpine image (NEW, separate from stage 1!)
  2. Load into memory (50 MB)
  3. This starts COMPLETELY FRESH
  4. Stage 1 still in memory but separate

Current Memory State:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 1 (builder): 1,425 MB     â”‚ â† Still in memory
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Stage 2 (production): 50 MB     â”‚ â† New, separate
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Read: WORKDIR /app
Think: "Create directory in production stage (NOT in builder!)"
Do:
  1. Create /app directory in production stage
  2. Set as working directory

Read: COPY package.json ./
Think: "Copy from HOST into production stage"
Do:
  1. Find package.json on host
  2. Copy to production stage /app/
  3. Create new layer in production stage

Read: RUN npm ci --only=production
Think: "Execute in production stage"
Do:
  1. Run npm ci in production stage
  2. Downloads only production packages (50 MB)
  3. Create new layer in production stage (50 MB)

Read: COPY --from=builder /build/dist ./dist
Think: "THIS IS SPECIAL! Copy from builder stage to production stage"
Do:
  1. Look at builder stage (stage 1)
  2. Find /build/dist directory there
  3. Copy that directory
  4. Place in production stage at ./dist
  5. Create new layer in production stage (5 MB)
  6. Note: ONLY this directory is copied, nothing else from builder!

Read: CMD ["node", "dist/index.js"]
Think: "Set startup command for production stage"
Do:
  1. Save command as metadata
  2. No new layer (just metadata)

Stage 2 Complete!
Total: 105 MB
Status: Final, this is the one to keep
```

### Step 4: Docker's Final Decision Logic

```
DOCKER'S CLEANUP LOGIC:

1. Check: Which stage is final?
   Answer: Stage 2 (the last FROM)

2. Decision: 
   - Keep Stage 2 âœ“
   - Delete Stage 1 âœ—

3. Execute:
   - Save Stage 2 layers to disk as "image"
   - Free memory used by Stage 1 (1,425 MB freed)
   - Delete all Stage 1 layers

4. Result:
   - Image file on disk: 105 MB (only Stage 2)
   - Stage 1 is completely gone, as if it never existed
```

---

## Memory and Deletion Logic {#memory-logic}

Let's understand EXACTLY what happens in memory:

### Memory Timeline During Build

```
TIME 0: Build Starts
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
RAM: Empty
Disk: Empty (no image yet)

TIME 1: Load Stage 1 Base Image
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
RAM: 
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 1: node:18 (900 MB)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Total RAM: 900 MB

TIME 2: Stage 1 - Copy Files
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
RAM:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 1:                     â”‚
â”‚  - Base: 900 MB              â”‚
â”‚  - Files: 20 MB              â”‚
â”‚  Total: 920 MB               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Total RAM: 920 MB

TIME 3: Stage 1 - Install Dependencies
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
RAM:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 1:                     â”‚
â”‚  - Base: 900 MB              â”‚
â”‚  - Files: 20 MB              â”‚
â”‚  - node_modules: 500 MB      â”‚
â”‚  Total: 1,420 MB             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Total RAM: 1,420 MB

TIME 4: Stage 1 - Build App
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
RAM:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 1:                     â”‚
â”‚  - Base: 900 MB              â”‚
â”‚  - Files: 20 MB              â”‚
â”‚  - node_modules: 500 MB      â”‚
â”‚  - dist/: 5 MB               â”‚
â”‚  Total: 1,425 MB             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Total RAM: 1,425 MB

TIME 5: Start Stage 2
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
RAM:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 1: 1,425 MB            â”‚ â† Still in RAM
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Stage 2: node:18-alpine      â”‚ â† NEW, loaded separately
â”‚          (50 MB)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Total RAM: 1,475 MB (both stages in memory!)

TIME 6: Stage 2 - Install Production Deps
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
RAM:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 1: 1,425 MB            â”‚ â† Still in RAM
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Stage 2:                     â”‚
â”‚  - Base: 50 MB               â”‚
â”‚  - Prod deps: 50 MB          â”‚
â”‚  Total: 100 MB               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Total RAM: 1,525 MB

TIME 7: Stage 2 - COPY from Builder
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
RAM:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 1: 1,425 MB            â”‚ â† Docker reads from here
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Stage 2:                     â”‚
â”‚  - Base: 50 MB               â”‚
â”‚  - Prod deps: 50 MB          â”‚
â”‚  - dist/ (from Stage 1): 5MB â”‚ â† Copied from Stage 1
â”‚  Total: 105 MB               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Total RAM: 1,530 MB

What happened:
1. Docker looked at Stage 1 memory
2. Found /dist directory (5 MB)
3. COPIED data from Stage 1 to Stage 2
4. Both copies exist temporarily

TIME 8: Build Complete - Docker's Cleanup
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Docker's Logic:
1. Stage 2 is final â†’ Save to disk
2. Stage 1 is not final â†’ Delete from RAM

RAM:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 2: 105 MB              â”‚ â† Being saved to disk
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Total RAM: 105 MB

Disk:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Image file: myapp:latest     â”‚
â”‚ Contains: Stage 2 layers     â”‚
â”‚ Size: 105 MB                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Stage 1: DELETED ğŸ—‘ï¸ (1,425 MB freed from RAM)

TIME 9: After Build
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
RAM: Empty (build process complete)
Disk: Image saved (105 MB)

Stage 1: Gone forever
Stage 2: Saved as the final image
```

### The Deletion Logic Explained

```
WHY DOES DOCKER DELETE STAGE 1?

Docker's Rule:
"Only the LAST stage in a Dockerfile becomes the final image.
 All previous stages are temporary workspaces."

Logic Flow:
1. Count FROM statements
2. Last FROM = Final stage
3. All other FROM = Temporary stages
4. After build: Delete all temporary stages

Example:
FROM node:18 AS builder        â† Stage 1 (temporary)
FROM node:18 AS tester         â† Stage 2 (temporary)
FROM node:18-alpine            â† Stage 3 (final)

Result after build:
- Stage 1: Deleted ğŸ—‘ï¸
- Stage 2: Deleted ğŸ—‘ï¸
- Stage 3: Kept âœ“

The image contains ONLY Stage 3.
Stages 1 and 2 existed only during build.
```

---

## The "Copy" Magic Explained {#copy-magic}

The most important part of multi-stage is COPY --from. Let's understand its logic:

### How COPY --from Works

```
COPY --from=builder /app/dist ./dist
      â”‚â”‚â”‚â”‚â”‚â”‚â”‚â”‚â”‚â”‚â”‚â”‚  â”‚â”‚â”‚â”‚â”‚â”‚â”‚â”‚â”‚  â”‚â”‚â”‚â”‚â”‚
      â”‚â”‚â”‚â”‚â”‚â”‚â”‚â”‚â”‚â”‚â”‚â”‚  â”‚â”‚â”‚â”‚â”‚â”‚â”‚â”‚â”‚  â””â”€â”€â”€â”€ Destination (current stage)
      â”‚â”‚â”‚â”‚â”‚â”‚â”‚â”‚â”‚â”‚â”‚â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Source path (in builder stage)
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Which stage to copy from

Docker's Logic:
1. "Look at the stage named 'builder'"
2. "Find the path /app/dist in that stage"
3. "Copy those files"
4. "Put them in current stage at ./dist"
5. "Only copy what I specified, nothing else"
```

### The Copy Process Step by Step

```
BEFORE COPY --from:

Stage 1 (builder) Memory:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ /                                   â”‚
â”‚ â”œâ”€â”€ app/                            â”‚
â”‚ â”‚   â”œâ”€â”€ src/              20 MB     â”‚ â† Source files
â”‚ â”‚   â”œâ”€â”€ node_modules/    500 MB     â”‚ â† All dependencies
â”‚ â”‚   â”œâ”€â”€ dist/              5 MB     â”‚ â† Built output âœ“
â”‚ â”‚   â”œâ”€â”€ package.json                â”‚
â”‚ â”‚   â””â”€â”€ tsconfig.json               â”‚
â”‚ â”œâ”€â”€ usr/                            â”‚
â”‚ â””â”€â”€ bin/                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Stage 2 (production) Memory:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ /                                   â”‚
â”‚ â”œâ”€â”€ app/                            â”‚
â”‚ â”‚   â””â”€â”€ (empty)                     â”‚
â”‚ â”œâ”€â”€ usr/                            â”‚
â”‚ â””â”€â”€ bin/                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

DURING COPY --from:

Docker executes: COPY --from=builder /app/dist ./dist

Step 1: Access builder stage memory
Step 2: Navigate to /app/dist
Step 3: Read all files in that directory
Step 4: Copy to production stage at /app/dist

AFTER COPY --from:

Stage 1 (builder) Memory:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Same as before                      â”‚
â”‚ (Nothing changed here)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Stage 2 (production) Memory:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ /                                   â”‚
â”‚ â”œâ”€â”€ app/                            â”‚
â”‚ â”‚   â””â”€â”€ dist/           5 MB âœ“      â”‚ â† Copied from builder
â”‚ â”‚       â”œâ”€â”€ index.js                â”‚
â”‚ â”‚       â”œâ”€â”€ bundle.js               â”‚
â”‚ â”‚       â””â”€â”€ assets/                 â”‚
â”‚ â”œâ”€â”€ usr/                            â”‚
â”‚ â””â”€â”€ bin/                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

KEY POINT: 
- Only /app/dist was copied (5 MB)
- src/ was NOT copied (saved 20 MB)
- node_modules/ was NOT copied (saved 500 MB)
- Everything else stayed in builder stage
```

### Multiple Copy Operations Logic

```
You can copy from the same stage multiple times:

COPY --from=builder /app/dist ./dist
COPY --from=builder /app/config ./config
COPY --from=builder /app/public ./public

Docker's Logic for Each:
1. Go to builder stage
2. Find specific path
3. Copy only that path
4. Add to current stage
5. Repeat for next COPY

Result:
Stage 2 has:
- /app/dist (from builder)
- /app/config (from builder)
- /app/public (from builder)

Stage 2 does NOT have:
- /app/src (not copied)
- /app/node_modules (not copied)
- /app/tests (not copied)
- Anything else not explicitly copied
```

---

## Why Only the Last Stage is Kept {#last-stage-logic}

Understanding WHY Docker keeps only the last stage is crucial:

### Docker's Stage Selection Logic

```
RULE: The image contains only the LAST FROM statement's result.

Why this rule exists:
1. Multi-stage is for building, not for multiple outputs
2. One Dockerfile = One final image
3. Previous stages are "build helpers"
4. Final stage is the "deliverable"

Example Dockerfile:

FROM node:18 AS dependencies     â† Stage 1
# ... install deps

FROM node:18 AS builder          â† Stage 2
# ... build app

FROM node:18 AS tester           â† Stage 3
# ... run tests

FROM node:18-alpine              â† Stage 4 (LAST)
# ... production setup

Docker's Decision Tree:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Is this the last FROM?              â”‚
â”‚                                     â”‚
â”‚ Stage 1 (dependencies): NO â†’ Delete â”‚
â”‚ Stage 2 (builder): NO â†’ Delete      â”‚
â”‚ Stage 3 (tester): NO â†’ Delete       â”‚
â”‚ Stage 4 (no name): YES â†’ KEEP âœ“     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Result: Image contains only Stage 4
```

### What if You Want to Keep a Different Stage?

```
Use --target flag:

docker build --target builder -t myapp:builder .
              ^^^^^^^^^^^^^^^^
              Stop at this stage and save it

With --target:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Is this the target stage?          â”‚
â”‚                                    â”‚
â”‚ Stage 1: NO â†’ Execute, then delete â”‚
â”‚ Stage 2 (builder): YES â†’ KEEP âœ“    â”‚
â”‚ Stage 3: NO â†’ Don't even execute   â”‚
â”‚ Stage 4: NO â†’ Don't even execute   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Result: Image contains only Stage 2
```

### The Logic of "Temporary" vs "Final"

```
Docker categorizes stages:

Temporary Stages:
- All stages except the last
- Purpose: Build helpers, intermediate steps
- Fate: Deleted after build
- Memory: Freed immediately after use
- Disk: Never saved to image file

Final Stage:
- The last stage in Dockerfile
- Purpose: The actual deliverable
- Fate: Saved as the image
- Memory: Saved to disk
- Disk: Becomes the image file

Visual Logic:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 1  â”‚ â†’ â”‚ Stage 2  â”‚ â†’ â”‚ Stage 3  â”‚ â†’ â”‚ Stage 4  â”‚
â”‚TEMPORARY â”‚   â”‚TEMPORARY â”‚   â”‚TEMPORARY â”‚   â”‚  FINAL   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚              â”‚              â”‚              â”‚
     â–¼              â–¼              â–¼              â–¼
  Delete         Delete         Delete          Save
    ğŸ—‘ï¸              ğŸ—‘ï¸              ğŸ—‘ï¸              âœ“
```

---

## Complete Example with Logic Flow {#complete-example}

Let's walk through a complete example with every logical step:

### The Dockerfile

```dockerfile
# Stage 1: Builder
FROM node:18 AS builder
WORKDIR /app
COPY package.json ./
RUN npm install
COPY src/ ./src/
RUN npm run build

# Stage 2: Production
FROM node:18-alpine
WORKDIR /app
RUN npm ci --only=production
COPY --from=builder /app/dist ./dist
CMD ["node", "dist/index.js"]
```

### Complete Logic Flow

```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STEP 1: Docker Analyzes Dockerfile
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Docker's Initial Analysis:
âœ“ Found 2 FROM statements
âœ“ Stage 1: FROM node:18 AS builder (temporary)
âœ“ Stage 2: FROM node:18-alpine (final)

Decision:
- Build both stages
- Keep only Stage 2 in final image
- Delete Stage 1 after build

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STEP 2: Execute Stage 1 (Builder)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Command: FROM node:18 AS builder
Logic:
  1. Check if node:18 exists locally
  2. If not, pull from Docker Hub
  3. Load into memory as "Stage 1"
  4. Label as "builder" for reference
  5. Current size: 900 MB

Memory State:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 1: 900 MB         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Command: WORKDIR /app
Logic:
  1. In Stage 1, create /app directory
  2. Set as working directory
  3. All subsequent commands run from /app
  4. New layer: 0 MB (just metadata)

Memory State:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 1: 900 MB         â”‚
â”‚  - /app/ created        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Command: COPY package.json ./
Logic:
  1. Find package.json on host computer
  2. Copy to Stage 1 at /app/package.json
  3. Create new layer with this file
  4. New layer: 2 KB

Memory State:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 1: 900 MB         â”‚
â”‚  - /app/package.json    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Command: RUN npm install
Logic:
  1. Execute npm install in Stage 1
  2. npm reads package.json
  3. Downloads all dependencies (prod + dev)
  4. Creates node_modules/ directory
  5. New layer: 500 MB

Memory State:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 1: 1,400 MB       â”‚
â”‚  - node_modules/ (500MB)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Command: COPY src/ ./src/
Logic:
  1. Find src/ directory on host
  2. Copy entire directory to Stage 1
  3. New layer: 20 MB

Memory State:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 1: 1,420 MB       â”‚
â”‚  - src/ (20 MB)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Command: RUN npm run build
Logic:
  1. Execute npm run build in Stage 1
  2. Webpack/TypeScript compiles src/
  3. Creates dist/ directory with compiled code
  4. New layer: 5 MB

Memory State:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 1: 1,425 MB       â”‚
â”‚  - dist/ (5 MB) âœ“       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Stage 1 Complete!
Status: Kept in memory for now (might be needed by Stage 2)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STEP 3: Execute Stage 2 (Production)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Command: FROM node:18-alpine
Logic:
  1. Start NEW stage (Stage 2)
  2. Pull node:18-alpine (different from Stage 1!)
  3. Load into memory SEPARATELY from Stage 1
  4. This is a fresh start
  5. Current size: 50 MB

Memory State:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 1: 1,425 MB       â”‚ â† Still in memory
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Stage 2: 50 MB          â”‚ â† New, separate
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Command: WORKDIR /app
Logic:
  1. In Stage 2, create /app directory
  2. Set as working directory for Stage 2
  3. Note: Stage 1 also has /app, but they're separate!

Memory State:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 1: 1,425 MB       â”‚
â”‚  - /app/                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Stage 2: 50 MB          â”‚
â”‚  - /app/                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Command: RUN npm ci --only=production
Logic:
  1. Wait, there's no package.json in Stage 2 yet!
  2. This command would fail!
  3. (Assuming package.json was copied earlier)
  4. npm installs only production dependencies
  5. New layer: 50 MB

Memory State:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 1: 1,425 MB       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Stage 2: 100 MB         â”‚
â”‚  - node_modules/ (50MB) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Command: COPY --from=builder /app/dist ./dist
Logic:
  1. "from=builder" â†’ Look at Stage 1 (named builder)
  2. Navigate to /app/dist in Stage 1
  3. Copy those files
  4. Place in Stage 2 at /app/dist
  5. New layer: 5 MB

Memory State:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 1: 1,425 MB       â”‚
â”‚  - /app/dist/ (5 MB)    â”‚ â† Read from here
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Stage 2: 105 MB         â”‚
â”‚  - dist/ (5 MB) âœ“       â”‚ â† Copied to here
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

KEY LOGIC:
- Only dist/ was copied (5 MB)
- src/ stayed in Stage 1 (NOT copied)
- Stage 1 node_modules stayed in Stage 1 (NOT copied)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Command: CMD ["node", "dist/index.js"]
Logic:
  1. Set startup command for Stage 2
  2. This is just metadata, no new layer
  3. Container will run this when started

Memory State: (No change)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 1: 1,425 MB       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Stage 2: 105 MB         â”‚
â”‚  - CMD set              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Stage 2 Complete!

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STEP 4: Docker's Final Cleanup
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Docker's Decision Logic:
1. Stage 2 is the last FROM
2. Therefore, Stage 2 is the final stage
3. Save Stage 2 to disk as the image
4. Delete Stage 1 (no longer needed)

Actions:
âœ“ Save Stage 2 layers to disk â†’ myapp:latest (105 MB)
âœ“ Free Stage 1 from memory â†’ 1,425 MB freed
âœ“ Build complete

Final Result:
Disk: myapp:latest = 105 MB (only Stage 2)
Stage 1: Gone forever ğŸ—‘ï¸

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STEP 5: When You Run the Container
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Command: docker run myapp:latest

Docker's Logic:
1. Load image from disk (105 MB)
2. This contains only Stage 2 layers
3. Create container from these layers
4. Execute CMD ["node", "dist/index.js"]

Container Contents:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ node:18-alpine base     â”‚
â”‚ node_modules/ (prod)    â”‚
â”‚ dist/ (from Stage 1)    â”‚
â”‚ Total: 105 MB           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

The container has NO IDEA Stage 1 ever existed!
```

---

## Common Questions About the Logic {#common-questions}

### Q1: Why can't I run commands from Stage 1 in my container?

```
ANSWER:

Stage 1 is COMPLETELY DELETED after build.

Logic:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ During Build:                       â”‚
â”‚ - Stage 1 exists in memory          â”‚
â”‚ - Stage 2 can copy from it          â”‚
â”‚                                     â”‚
â”‚ After Build:                        â”‚
â”‚ - Stage 1 is deleted                â”‚
â”‚ - Only Stage 2 saved as image       â”‚
â”‚                                     â”‚
â”‚ During Container Run:               â”‚
â”‚ - Container created from Stage 2    â”‚
â”‚ - Stage 1 doesn't exist anywhere    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Example:
# Stage 1 has TypeScript compiler
FROM node:18 AS builder
RUN npm install typescript

# Stage 2 doesn't have it
FROM node:18-alpine
COPY --from=builder /app/dist ./dist

In running container:
$ tsc --version
bash: tsc: command not found

Why? Because TypeScript was in Stage 1, which is gone!
```

### Q2: Can Stage 2 access Stage 1's environment variables?

```
ANSWER: NO

Logic:
Each stage is completely independent.

Stage 1:
ENV MY_VAR=hello

Stage 2:
FROM node:18-alpine
RUN echo $MY_VAR  # This is EMPTY!

Why? Stage 2 started fresh from node:18-alpine,
which doesn't have MY_VAR.

Solution:
Set ENV again in Stage 2:
ENV MY_VAR=hello
```

### Q3: What happens if I COPY from a stage that doesn't exist?

```
ANSWER: Build fails

COPY --from=nonexistent /app/dist ./dist
              ^^^^^^^^^^^
              Docker can't find this stage

Error: invalid from flag value nonexistent: 
       stage does not exist

Logic:
1. Docker looks for stage named "nonexistent"
2. Doesn't find it in the Dockerfile
3. Throws error and stops build
```

### Q4: Can I copy from Stage 2 back to Stage 1?

```
ANSWER: NO, stages are built in order

Logic:
Stage 1 builds first
   â†“
Stage 2 builds second
   â†“
Can't go backwards

Example (DOESN'T WORK):
FROM node:18 AS builder
COPY --from=production /app/data ./data  â† FAIL!

FROM node:18-alpine AS production
# ...

Error: production stage hasn't been built yet when
       builder stage tries to copy from it

You can only copy from EARLIER stages, not later ones.
```

### Q5: Why does my builder stage take so long if it gets deleted anyway?

```
ANSWER: It's necessary to create what you need!

Logic:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Think of it like baking a cake:     â”‚
â”‚                                     â”‚
â”‚ Stage 1 (Kitchen - takes time):     â”‚
â”‚ - Mix ingredients (10 min)          â”‚
â”‚ - Bake in oven (45 min)             â”‚
â”‚ - Let cool (30 min)                 â”‚
â”‚ - Frost and decorate (20 min)       â”‚
â”‚ Total: 105 minutes                  â”‚
â”‚                                     â”‚
â”‚ Stage 2 (Serving):                  â”‚
â”‚ - Take finished cake                â”‚
â”‚ - Put on plate                      â”‚
â”‚ Total: 1 minute                     â”‚
â”‚                                     â”‚
â”‚ You need the 105 minutes in the     â”‚
â”‚ kitchen to make the cake, even      â”‚
â”‚ though you only keep the cake,      â”‚
â”‚ not the kitchen!                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

The time spent in Stage 1 is the "build time"
needed to create your application.
```

### Q6: Can I have more than 2 stages?

```
ANSWER: YES! You can have unlimited stages.

Example with 4 stages:

FROM node:18 AS dependencies
# Install deps

FROM node:18 AS builder
# Build app

FROM node:18 AS tester
# Run tests

FROM node:18-alpine AS production
# Final image

Logic:
- Stage 1 (dependencies): Temporary, deleted
- Stage 2 (builder): Temporary, deleted
- Stage 3 (tester): Temporary, deleted
- Stage 4 (production): FINAL, kept

Each stage can copy from any previous stage:

Stage 2 can copy from Stage 1 âœ“
Stage 3 can copy from Stage 1 or 2 âœ“
Stage 4 can copy from Stage 1, 2, or 3 âœ“

But:
Stage 1 can't copy from Stage 2 âœ— (2 doesn't exist yet)
```

### Q7: Does multi-stage building increase build time?

```
ANSWER: It can, but it's worth it!

Single-Stage Build Time:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Load base image (node:18)   2 min   â”‚
â”‚ Install dependencies         5 min  â”‚
â”‚ Build application            3 min  â”‚
â”‚ Total: 10 minutes                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Multi-Stage Build Time:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 1:                            â”‚
â”‚ - Load base (node:18)        2 min  â”‚
â”‚ - Install deps               5 min  â”‚
â”‚ - Build app                  3 min  â”‚
â”‚                                     â”‚
â”‚ Stage 2:                            â”‚
â”‚ - Load base (alpine)         1 min  â”‚
â”‚ - Install prod deps          2 min  â”‚
â”‚ - Copy from Stage 1          10 sec â”‚
â”‚                                     â”‚
â”‚ Total: 13 minutes 10 seconds        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

BUT:
- Single-stage image: 1,025 MB
- Multi-stage image: 105 MB

Trade-off:
+ 3 extra minutes build time
- 920 MB image size (90% smaller!)

Worth it because:
- Deploy time much faster (105 MB vs 1,025 MB)
- Storage much cheaper
- Security much better (smaller attack surface)
- Build time is one-time, deploy happens many times
```

---

## Summary: The Complete Logic in One Page

```
MULTI-STAGE BUILD LOGIC - COMPLETE SUMMARY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CONCEPT:
Build with all tools â†’ Copy only result â†’ Discard tools

STAGES:
- Multiple FROM statements = Multiple stages
- Each stage is independent and isolated
- Last stage = Final image (kept)
- All other stages = Temporary (deleted)

BUILD PROCESS:
1. Execute Stage 1 with all build tools
2. Execute Stage 2 with minimal runtime
3. Use COPY --from to transfer artifacts
4. Delete Stage 1, keep only Stage 2

MEMORY LOGIC:
- Each stage exists separately in memory
- Stages can read from previous stages
- Final stage saved to disk
- Temporary stages deleted from memory

FILE COPY LOGIC:
- COPY --from=stage reads from named stage
- Only specified files are copied
- Everything else stays in source stage
- Source stage is deleted after build

SIZE REDUCTION:
- Build tools: In Stage 1, deleted
- Source code: In Stage 1, deleted
- Dev dependencies: In Stage 1, deleted
- Built artifacts: Copied to Stage 2, kept
- Prod dependencies: Installed in Stage 2, kept

FINAL IMAGE:
- Contains only final stage layers
- Previous stages completely gone
- No trace of build process
- Minimal size with only runtime needs

KEY BENEFITS:
âœ“ Smaller images (60-95% reduction)
âœ“ Faster deployments
âœ“ Better security
âœ“ Cleaner separation of concerns
âœ“ Same build, minimal runtime
```

The logic is simple: **Build big, ship small!**