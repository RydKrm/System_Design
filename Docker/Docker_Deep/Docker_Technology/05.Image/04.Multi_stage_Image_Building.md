# Multi-Stage Docker Builds: Complete Beginner's Guide

## Table of Contents

1. [Understanding the Fundamental Problem](https://claude.ai/chat/1aeaf5cc-96d4-4c4b-bd25-c56339a51961#understanding-the-problem)
2. [What is Multi-Stage Building?](https://claude.ai/chat/1aeaf5cc-96d4-4c4b-bd25-c56339a51961#what-is-multi-stage)
3. [How Docker Stores Images in Memory](https://claude.ai/chat/1aeaf5cc-96d4-4c4b-bd25-c56339a51961#docker-memory-structure)
4. [Stage Labels and Naming](https://claude.ai/chat/1aeaf5cc-96d4-4c4b-bd25-c56339a51961#stage-labels)
5. [How Files Copy Between Stages](https://claude.ai/chat/1aeaf5cc-96d4-4c4b-bd25-c56339a51961#file-copying)
6. [How Dependencies Work in Multi-Stage](https://claude.ai/chat/1aeaf5cc-96d4-4c4b-bd25-c56339a51961#dependencies)
7. [Base Images in Multi-Stage Builds](https://claude.ai/chat/1aeaf5cc-96d4-4c4b-bd25-c56339a51961#base-images)
8. [Production Stage Optimization](https://claude.ai/chat/1aeaf5cc-96d4-4c4b-bd25-c56339a51961#production-stage)
9. [Complete Step-by-Step Example](https://claude.ai/chat/1aeaf5cc-96d4-4c4b-bd25-c56339a51961#complete-example)
10. [Memory and Size Reduction Explained](https://claude.ai/chat/1aeaf5cc-96d4-4c4b-bd25-c56339a51961#size-reduction)
11. [Advanced Patterns](https://claude.ai/chat/1aeaf5cc-96d4-4c4b-bd25-c56339a51961#advanced-patterns)
12. [Real-World Scenarios](https://claude.ai/chat/1aeaf5cc-96d4-4c4b-bd25-c56339a51961#real-world-scenarios)

---

## Understanding the Fundamental Problem {#understanding-the-problem}

Before we understand multi-stage builds, let's understand the problem they solve. Imagine you're building a house.

### The Traditional Single-Stage Problem (Building a House Analogy)

```
Traditional Single-Stage Dockerfile = Building AND Living in Same Space

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    YOUR HOUSE                           â”‚
â”‚                                                         â”‚
â”‚  Living Room (Your App)           50 sq ft              â”‚
â”‚  â”œâ”€ Furniture (App Code)          10 sq ft              â”‚
â”‚  â””â”€ Decorations (Config Files)    5 sq ft               â”‚
â”‚                                                         â”‚
â”‚  Construction Zone (Build Tools)  500 sq ft âš ï¸          â”‚
â”‚  â”œâ”€ Cement Mixer (Compiler)       100 sq ft             â”‚
â”‚  â”œâ”€ Power Tools (Build Tools)     150 sq ft             â”‚
â”‚  â”œâ”€ Lumber Pile (Source Code)     100 sq ft             â”‚
â”‚  â”œâ”€ Paint Cans (Dependencies)     100 sq ft             â”‚
â”‚  â””â”€ Construction Debris            50 sq ft             â”‚
â”‚                                                         â”‚
â”‚  Storage (Unnecessary Stuff)      200 sq ft âš ï¸          â”‚
â”‚  â”œâ”€ Old blueprints                 50 sq ft             â”‚
â”‚  â”œâ”€ Leftover materials             100 sq ft            â”‚
â”‚  â””â”€ Packaging boxes                50 sq ft             â”‚ 
â”‚                                                         â”‚
â”‚  TOTAL SIZE: 750 sq ft                                  â”‚
â”‚  (You only need 65 sq ft but paying for 750!)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**The Problem**: You built a house, and now you're living in it. But you still have ALL the construction equipment, leftover materials, and debris from building it. You pay rent on 750 square feet, but you only actually use 65 square feet for living!

### Single-Stage Dockerfile Example

Let's see this in real Docker code:

```dockerfile
# Single-Stage Dockerfile (INEFFICIENT)
FROM node:18

WORKDIR /app

# Copy everything needed to build
COPY package.json package-lock.json ./
COPY src/ ./src/
COPY tests/ ./tests/
COPY build-scripts/ ./build-scripts/

# Install EVERYTHING (production + development tools)
RUN npm install

# Build the application
RUN npm run build

# The final image contains:
# âœ“ Built application (dist/ folder) - 5 MB (NEED THIS)
# âœ— Source code (src/ folder) - 20 MB (DON'T NEED)
# âœ— Tests (tests/ folder) - 10 MB (DON'T NEED)
# âœ— Build scripts - 5 MB (DON'T NEED)
# âœ— node_modules with dev dependencies - 500 MB (DON'T NEED)
# âœ— npm cache - 100 MB (DON'T NEED)
# Total: 640 MB (Only need 5 MB!)

CMD ["node", "dist/index.js"]
```

**What's in Memory/Disk**:

```
Docker Image on Disk: 640 MB
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 1: Base Node.js image (200MB) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 2: Source files copied (35MB) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 3: npm install (500MB)        â”‚
â”‚   - Production dependencies         â”‚
â”‚   - Development dependencies âš ï¸     â”‚
â”‚   - Build tools âš ï¸                  â”‚
â”‚   - Testing libraries âš ï¸            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 4: Build output (5MB)         â”‚
â”‚   - dist/ folder âœ“                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 5: CMD instruction (tiny)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Every time you deploy this image:
- Download: 640 MB
- Storage used: 640 MB
- Money wasted on 635 MB you don't need!
```

---

## What is Multi-Stage Building? {#what-is-multi-stage}

Multi-stage building is like having TWO separate buildings:

1. **Construction Site** - Where you build everything
2. **Final Home** - Where you only move the finished product

### The Multi-Stage Solution (Two Buildings Analogy)

```
Multi-Stage Dockerfile = Separate Building Site + Final Home

STAGE 1: CONSTRUCTION SITE (Temporary)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             CONSTRUCTION SITE                           â”‚
â”‚  (This entire building will be THROWN AWAY!)            â”‚
â”‚                                                         â”‚
â”‚  Construction Zone                500 sq ft             â”‚
â”‚  â”œâ”€ Cement Mixer                  100 sq ft             â”‚
â”‚  â”œâ”€ Power Tools                   150 sq ft             â”‚
â”‚  â”œâ”€ Lumber Pile                   100 sq ft             â”‚
â”‚  â”œâ”€ Paint Cans                    100 sq ft             â”‚
â”‚  â””â”€ Construction Debris            50 sq ft             â”‚
â”‚                                                         â”‚
â”‚  â¬‡ï¸ BUILD FURNITURE â¬‡ï¸                                 â”‚
â”‚  â¬‡ï¸ CREATE DECORATIONS â¬‡ï¸                              â”‚
â”‚  â¬‡ï¸ FINISH EVERYTHING â¬‡ï¸                               â”‚
â”‚                                                         â”‚
â”‚  Finished Products Ready to Move   65 sq ft             â”‚
â”‚  â”œâ”€ Furniture âœ“                    10 sq ft             â”‚
â”‚  â”œâ”€ Decorations âœ“                   5 sq ft             â”‚
â”‚  â””â”€ Everything Ready âœ“             50 sq ft             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ COPY ONLY FINISHED PRODUCTS â¬‡ï¸
        â”‚
        â–¼
STAGE 2: FINAL HOME (This is what you keep!)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  YOUR FINAL HOME                        â”‚
â”‚                                                         â”‚
â”‚  Living Room (Your App)           65 sq ft              â”‚
â”‚  â”œâ”€ Furniture (App Code) âœ“        10 sq ft              â”‚
â”‚  â”œâ”€ Decorations (Config) âœ“         5 sq ft              â”‚
â”‚  â””â”€ Everything Ready âœ“             50 sq ft             â”‚
â”‚                                                         â”‚
â”‚  TOTAL SIZE: 65 sq ft âœ“                                 â”‚
â”‚  (Perfect! Only what you need!)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Construction site = DELETED! 
Only the final home remains!
```

**Key Concept**: You build in Stage 1 (with all the tools), then **COPY ONLY** the finished product to Stage 2. Stage 1 is thrown away completely!

### Multi-Stage Dockerfile Example

```dockerfile
# ============================================
# STAGE 1: BUILDER (This will be deleted!)
# ============================================
FROM node:18 AS builder

WORKDIR /app

# Copy everything needed to build
COPY package.json package-lock.json ./
COPY src/ ./src/
COPY build-scripts/ ./build-scripts/

# Install EVERYTHING (it's okay, this stage gets deleted)
RUN npm install

# Build the application
RUN npm run build
# This creates dist/ folder with compiled code

# At this point, builder stage contains:
# - Source code (src/)
# - node_modules (500 MB)
# - Build scripts
# - Built output (dist/)
# Total: 640 MB

# ============================================
# STAGE 2: PRODUCTION (This is what we keep!)
# ============================================
FROM node:18-alpine

WORKDIR /app

# Copy ONLY the built application from builder stage
COPY --from=builder /app/dist ./dist

# Copy ONLY production dependencies
COPY --from=builder /app/node_modules ./node_modules

# Copy configuration files
COPY package.json ./

# This final image contains:
# âœ“ Built application (dist/) - 5 MB
# âœ“ Production dependencies - 50 MB
# âœ“ package.json - tiny
# Total: 55 MB (92% smaller!)

CMD ["node", "dist/index.js"]
```

**What's in Memory/Disk Now**:

```
BUILDER STAGE (Temporary - Gets Deleted):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ This entire stage = 640 MB          â”‚
â”‚ Gets completely thrown away! ğŸ—‘ï¸     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â¬‡ï¸ Copy only dist/ folder
        
PRODUCTION STAGE (Final - Kept):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 1: Alpine base (50MB)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 2: dist/ folder copied (5MB)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 3: CMD instruction (tiny)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Final image: 55 MB

Savings: 640 MB â†’ 55 MB (91% reduction!)
```

---

## How Docker Stores Images in Memory {#docker-memory-structure}

To truly understand multi-stage builds, you need to understand how Docker stores images in memory. Let's use a very detailed analogy.

### Docker Image Storage: The Filing Cabinet Analogy

Think of a Docker image as a filing cabinet with drawers stacked on top of each other. Each drawer is a "layer."

```
Docker Image = Filing Cabinet with Stacked Drawers (Layers)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         DOCKER IMAGE: myapp:latest          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 5 (Top Drawer)                        â”‚
â”‚ CMD ["node", "dist/index.js"]               â”‚
â”‚ Size: 0 bytes (just metadata)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 4                                     â”‚
â”‚ Files: dist/index.js, dist/utils.js         â”‚
â”‚ Size: 5 MB                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 3                                     â”‚
â”‚ Files: node_modules/ (500 MB)               â”‚
â”‚ Size: 500 MB                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 2                                     â”‚
â”‚ Files: src/app.js, src/helpers.js           â”‚
â”‚ Size: 20 MB                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 1 (Bottom Drawer - Base)              â”‚
â”‚ Files: Ubuntu OS, Node.js                   â”‚
â”‚ Size: 200 MB                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Total Image Size: 725 MB
(200 + 20 + 500 + 5 + 0 = 725 MB)
```

### Important Layer Properties

**Property 1: Layers are Read-Only**

Once a layer is created, it NEVER changes. It's like a drawer that's been sealed with super glue.

```
Layer 3 created and sealed:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 3 [LOCKED ğŸ”’]                          â”‚
â”‚ node_modules/ folder (500 MB)               â”‚
â”‚                                             â”‚
â”‚ This layer is now PERMANENT                 â”‚
â”‚ Cannot be modified                          â”‚
â”‚ Cannot delete files from it                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Property 2: Layers Stack and Merge**

When you run a container, Docker stacks all layers and shows you a merged view:

```
You see (Merged View):
/app
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app.js (from Layer 2)
â”‚   â””â”€â”€ helpers.js (from Layer 2)
â”œâ”€â”€ node_modules/
â”‚   â””â”€â”€ [500 MB of packages] (from Layer 3)
â”œâ”€â”€ dist/
â”‚   â”œâ”€â”€ index.js (from Layer 4)
â”‚   â””â”€â”€ utils.js (from Layer 4)

But actually stored as separate layers:
Layer 1: Base OS
Layer 2: src/
Layer 3: node_modules/
Layer 4: dist/
Layer 5: CMD
```

**Property 3: Deleting Files Creates "Whiteout" Markers**

This is CRITICAL to understand why single-stage builds are wasteful:

```dockerfile
# Dockerfile example
FROM ubuntu
RUN apt-get install -y build-tools  # Layer 1: +100 MB
RUN rm -rf /var/lib/apt/lists/*     # Layer 2: +0 MB (but Layer 1 still exists!)
```

**What Actually Happens**:

```
Layer 1 (Created by first RUN):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ /var/lib/apt/lists/                         â”‚
â”‚   â”œâ”€â”€ package-list-1                        â”‚
â”‚   â”œâ”€â”€ package-list-2                        â”‚
â”‚   â””â”€â”€ ... (100 MB of files)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Layer 2 (Created by second RUN):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ .wh./var/lib/apt/lists/                     â”‚
â”‚ (whiteout marker - hides Layer 1 files)     â”‚
â”‚                                             â”‚
â”‚ Size: 4 KB (just the marker)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

What you see when running container:
/var/lib/apt/lists/ appears empty âœ“

What's actually on disk:
Layer 1: 100 MB âš ï¸
Layer 2: 4 KB
Total: 100.004 MB (Layer 1 is still there!)
```

**This is why combining commands is important**:

```dockerfile
# âŒ BAD (2 layers, both saved)
RUN apt-get install -y build-tools  # Layer 1: 100 MB
RUN rm -rf /var/lib/apt/lists/*     # Layer 2: 4 KB marker
# Total: 100 MB still exists!

# âœ… GOOD (1 layer, cleanup happens before layer is saved)
RUN apt-get install -y build-tools && \
    rm -rf /var/lib/apt/lists/*
# Total: Files deleted before layer sealed = 0 MB cache!
```

---

## Stage Labels and Naming {#stage-labels}

In multi-stage builds, we give each stage a name (label) so we can reference it later. Think of it like naming different floors of a building.

### Understanding AS (Stage Labels)

```dockerfile
FROM node:18 AS builder
#              ^^^^^^^^^^
#              This is the stage label/name
```

This is exactly like naming a person so you can refer to them later:

```
Person: John Smith
        ^^^^
        Name/label you use to refer to this person

Stage: node:18 AS builder
                  ^^^^^^^
                  Name/label you use to refer to this stage
```

### Visual Representation of Labeled Stages

```
Docker Build Process with Labeled Stages:

Stage 1: FROM node:18 AS builder
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         BUILDER STAGE                       â”‚
â”‚  Label/Name: "builder"                      â”‚
â”‚  Base Image: node:18                        â”‚
â”‚                                             â”‚
â”‚  Contents:                                  â”‚
â”‚  â”œâ”€â”€ /app/src/ (source code)                â”‚
â”‚  â”œâ”€â”€ /app/node_modules/ (all deps)          â”‚
â”‚  â”œâ”€â”€ /app/dist/ (built output) âœ“            â”‚
â”‚  â””â”€â”€ Build tools and cache                  â”‚
â”‚                                             â”‚
â”‚  Size: 640 MB                               â”‚
â”‚  Status: TEMPORARY (will be deleted)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ Referenced by name "builder" â¬‡ï¸
        â”‚
Stage 2: FROM node:18-alpine AS production
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        PRODUCTION STAGE                     â”‚
â”‚  Label/Name: "production"                   â”‚
â”‚  Base Image: node:18-alpine                 â”‚
â”‚                                             â”‚
â”‚  Contents:                                  â”‚
â”‚  â”œâ”€â”€ /app/dist/ (copied from builder) âœ“     â”‚
â”‚  â””â”€â”€ Minimal runtime only                   â”‚
â”‚                                             â”‚
â”‚  Size: 55 MB                                â”‚
â”‚  Status: FINAL (this is kept!)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### How Stage Labels Work in Code

```dockerfile
# ============================================
# Stage 1: Give it a name "build-stage"
# ============================================
FROM python:3.11 AS build-stage
#                  ^^^^^^^^^^^
#                  This is just a name, you can call it anything:
#                  - builder
#                  - build-stage
#                  - compile-stage
#                  - my-build-stage
#                  - stage1

WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .
RUN python setup.py build

# ============================================
# Stage 2: Give it a name "final"
# ============================================
FROM python:3.11-slim AS final
#                         ^^^^^
#                         Another name for this stage

# Now we can copy from "build-stage" using its name!
COPY --from=build-stage /app/build ./build
#            ^^^^^^^^^^^
#            This refers to the stage named "build-stage"
```

### Multiple Ways to Reference Stages

```dockerfile
# Method 1: Reference by name (RECOMMENDED)
FROM node:18 AS builder
FROM node:18-alpine AS production
COPY --from=builder /app/dist ./dist

# Method 2: Reference by index (NOT RECOMMENDED)
FROM node:18          # This is stage 0
FROM node:18-alpine   # This is stage 1
COPY --from=0 /app/dist ./dist  # Reference stage 0

# Method 3: Reference external image
FROM node:18 AS builder
FROM node:18-alpine
COPY --from=nginx:alpine /etc/nginx/nginx.conf ./
#            ^^^^^^^^^^^^
#            This copies from an external image, not from a stage
```

**Best Practice**: Always use meaningful names with AS:

```dockerfile
# âœ… GOOD - Clear names
FROM node:18 AS dependencies-installer
FROM node:18 AS application-builder
FROM node:18-alpine AS production-runtime

# âŒ BAD - Unclear
FROM node:18 AS stage1
FROM node:18 AS stage2
FROM node:18-alpine AS stage3
```

---

## How Files Copy Between Stages {#file-copying}

This is where the magic happens! Understanding how COPY --from works is crucial. Let's visualize it step by step.

### The COPY --from Command

```dockerfile
COPY --from=builder /app/dist ./dist
#           ^^^^^^^  ^^^^^^^^^  ^^^^^
#           |        |          |
#           |        |          â””â”€â”€ Destination (current stage)
#           |        â””â”€â”€ Source path (in builder stage)
#           â””â”€â”€ Which stage to copy from
```

### Visual Step-by-Step File Copying

**Step 1: Builder Stage Creates Files**

```dockerfile
FROM node:18 AS builder
WORKDIR /app
COPY . .
RUN npm run build
```

**What's in the builder stage's filesystem**:

```
BUILDER STAGE FILESYSTEM:
/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ index.js         (source code - 2 KB)
â”‚   â”‚   â”œâ”€â”€ utils.js         (source code - 1 KB)
â”‚   â”‚   â””â”€â”€ helpers.js       (source code - 3 KB)
â”‚   â”œâ”€â”€ node_modules/
â”‚   â”‚   â”œâ”€â”€ express/         (dependency - 200 KB)
â”‚   â”‚   â”œâ”€â”€ lodash/          (dependency - 150 KB)
â”‚   â”‚   â””â”€â”€ [500+ packages]  (total: 500 MB) âš ï¸
â”‚   â”œâ”€â”€ dist/               âœ“ BUILT OUTPUT - This is what we want!
â”‚   â”‚   â”œâ”€â”€ index.js        (compiled - 3 KB)
â”‚   â”‚   â”œâ”€â”€ bundle.js       (bundled - 2 MB)
â”‚   â”‚   â””â”€â”€ assets/         (images - 500 KB)
â”‚   â”œâ”€â”€ tests/              (test files - 10 MB) âš ï¸
â”‚   â”œâ”€â”€ package.json        (manifest - 2 KB)
â”‚   â””â”€â”€ package-lock.json   (lock file - 50 KB)
â”œâ”€â”€ usr/
â”œâ”€â”€ bin/
â””â”€â”€ ... (rest of operating system)

Total size: ~640 MB
We only want the dist/ folder (2.5 MB)
```

**Step 2: Production Stage Starts Clean**

```dockerfile
FROM node:18-alpine
```

**Initial production stage filesystem** (before any COPY):

```
PRODUCTION STAGE FILESYSTEM (empty):
/
â”œâ”€â”€ usr/
â”œâ”€â”€ bin/
â”œâ”€â”€ lib/
â””â”€â”€ ... (only Alpine Linux + Node.js - 50 MB)

No /app/ directory yet
No application files yet
```

**Step 3: COPY --from Copies Specific Files**

```dockerfile
COPY --from=builder /app/dist ./dist
```

**This command does the following**:

1. Look at builder stage's filesystem
2. Find the /app/dist directory
3. Copy ONLY that directory to current stage
4. Place it at ./dist (which is /app/dist since WORKDIR is /app)

```
BEFORE COPY --from:
BUILDER STAGE                    PRODUCTION STAGE
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ /app/           â”‚              â”‚ /app/           â”‚
â”‚  â”œâ”€â”€ src/       â”‚              â”‚  (empty)        â”‚
â”‚  â”œâ”€â”€ node_modules/             â”‚                 â”‚
â”‚  â”œâ”€â”€ dist/ âœ“    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚  (nothing)      â”‚
â”‚  â””â”€â”€ tests/     â”‚  COPY --from â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

AFTER COPY --from:
BUILDER STAGE                    PRODUCTION STAGE
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ /app/           â”‚              â”‚ /app/           â”‚
â”‚  â”œâ”€â”€ src/       â”‚              â”‚  â””â”€â”€ dist/ âœ“    â”‚
â”‚  â”œâ”€â”€ node_modules/  Not copied â†’  â”‚  â”œâ”€â”€ index.jsâ”‚
â”‚  â”œâ”€â”€ dist/ âœ“    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚  â”œâ”€â”€ bundle.js  â”‚
â”‚  â””â”€â”€ tests/     â”‚   Only dist! â”‚  â””â”€â”€ assets/    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**The Key Point**: Everything else (src/, node_modules/, tests/) stays in the builder stage and gets deleted when the build finishes!

### Multiple COPY --from Commands

You can copy multiple things from different stages:

```dockerfile
# Stage 1: Build frontend
FROM node:18 AS frontend-builder
WORKDIR /frontend
COPY frontend/package*.json ./
RUN npm install
COPY frontend/ ./
RUN npm run build
# Creates: /frontend/dist/

# Stage 2: Build backend
FROM node:18 AS backend-builder
WORKDIR /backend
COPY backend/package*.json ./
RUN npm install
COPY backend/ ./
RUN npm run build
# Creates: /backend/dist/

# Stage 3: Production
FROM node:18-alpine

WORKDIR /app

# Copy from frontend builder
COPY --from=frontend-builder /frontend/dist ./public
#            ^^^^^^^^^^^^^^^^ From first stage

# Copy from backend builder
COPY --from=backend-builder /backend/dist ./api
#            ^^^^^^^^^^^^^^ From second stage

# Final structure in production:
# /app/
#   â”œâ”€â”€ public/  (from frontend-builder)
#   â””â”€â”€ api/     (from backend-builder)
```

**Visual Representation**:

```
FRONTEND-BUILDER          BACKEND-BUILDER            PRODUCTION
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ /frontend/   â”‚          â”‚ /backend/    â”‚           â”‚ /app/        â”‚
â”‚  â”œâ”€â”€ src/    â”‚          â”‚  â”œâ”€â”€ src/    â”‚           â”‚              â”‚
â”‚  â”œâ”€â”€ node_modules/      â”‚  â”œâ”€â”€ node_modules/       â”‚              â”‚
â”‚  â””â”€â”€ dist/ âœ“â”‚â”€â”€â”€â”€â”€â”€â”    â”‚  â””â”€â”€ dist/ âœ“â”‚â”€-â”€â”€â”€â”€â”€â”    â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚    â”‚              â”‚
                      â”‚                         â”‚    â”‚              â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚              â”‚
                                   â”‚                 â”‚              â”‚
                                   â–¼                 â–¼              â”‚
                              COPY --from      COPY --from          â”‚
                                   â”‚                 â”‚              â”‚
                                   â–¼                 â–¼              â”‚
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
                           â”‚ /app/                      â”‚           â”‚
                           â”‚  â”œâ”€â”€ public/ âœ“ (from frontend)         â”‚
                           â”‚  â””â”€â”€ api/ âœ“    (from backend)          â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
```

### Copying with Ownership

You can set file ownership while copying:

```dockerfile
FROM node:18 AS builder
WORKDIR /app
COPY . .
RUN npm run build

FROM node:18-alpine

# Create user
RUN adduser -D appuser

WORKDIR /app

# Copy with ownership
COPY --from=builder --chown=appuser:appuser /app/dist ./dist
#                   ^^^^^^^^^^^^^^^^^^^^^
#                   Set owner and group while copying

USER appuser
CMD ["node", "dist/index.js"]
```

**What Happens**:

```
BUILDER STAGE              PRODUCTION STAGE
Files owned by root        Files owned by appuser
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ /app/dist/  â”‚            â”‚ /app/dist/  â”‚
â”‚  (root:root)â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚  (appuser:  â”‚
â”‚             â”‚  COPY with â”‚   appuser)  â”‚
â”‚             â”‚  --chown   â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## How Dependencies Work in Multi-Stage {#dependencies}

Dependencies (like npm packages, pip packages, etc.) are usually the biggest part of an image. Let's understand how multi-stage builds optimize them.

### The Dependency Problem

When you install dependencies, you often install more than you need:

```
npm install installs:

Production Dependencies:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ express          (needed at runtime)â”‚
â”‚ body-parser      (needed at runtime)â”‚
â”‚ mongoose         (needed at runtime)â”‚
â”‚ dotenv           (needed at runtime)â”‚
â”‚                                     â”‚
â”‚ Total: 50 MB                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Development Dependencies:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ webpack          (only for building)â”‚
â”‚ babel            (only for building)â”‚
â”‚ eslint           (only for linting) â”‚
â”‚ jest             (only for testing) â”‚
â”‚ typescript       (only for building)â”‚
â”‚ @types/*         (only for TypeScript) â”‚
â”‚                                     â”‚
â”‚ Total: 450 MB âš ï¸                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Total Installed: 500 MB
Actually Need at Runtime: 50 MB
Waste: 450 MB (90%)!
```

### Solution: Separate Dependency Installation

**Pattern 1: Install All Dependencies in Builder, Copy Only Production to Final**

```dockerfile
# ============================================
# BUILDER STAGE
# ============================================
FROM node:18 AS builder

WORKDIR /app

# Copy package files
COPY package.json package-lock.json ./

# Install ALL dependencies (production + dev)
RUN npm install
# This installs 500 MB of packages

# Build the application (requires dev dependencies)
COPY . .
RUN npm run build
# This uses webpack, babel, etc. from node_modules

# ============================================
# PRODUCTION STAGE
# ============================================
FROM node:18-alpine

WORKDIR /app

# Install ONLY production dependencies (fresh install)
COPY package.json package-lock.json ./
RUN npm ci --only=production
# This installs only 50 MB

# Copy built application from builder
COPY --from=builder /app/dist ./dist

CMD ["node", "dist/index.js"]
```

**What Happens in Memory**:

```
BUILDER STAGE (Temporary):
/app/node_modules/ = 500 MB
  â”œâ”€â”€ express/          (production) âœ“
  â”œâ”€â”€ mongoose/         (production) âœ“
  â”œâ”€â”€ webpack/          (dev only) âš ï¸
  â”œâ”€â”€ babel/            (dev only) âš ï¸
  â”œâ”€â”€ eslint/           (dev only) âš ï¸
  â””â”€â”€ jest/             (dev only) âš ï¸
  
[This entire stage gets DELETED! ğŸ—‘ï¸]

PRODUCTION STAGE (Final):
/app/node_modules/ = 50 MB
  â”œâ”€â”€ express/          (production) âœ“
  â”œâ”€â”€ mongoose/         (production) âœ“
  â””â”€â”€ (only production packages)

Savings: 500 MB â†’ 50 MB (90% reduction!)
```

**Pattern 2: Copy Production Dependencies from Builder**

```dockerfile
# ============================================
# DEPENDENCIES STAGE (Only for dependencies)
# ============================================
FROM node:18 AS dependencies

WORKDIR /app

COPY package.json package-lock.json ./

# Install ONLY production dependencies
RUN npm ci --only=production && npm cache clean --force

# ============================================
# BUILDER STAGE (For building)
# ============================================
FROM node:18 AS builder

WORKDIR /app

COPY package.json package-lock.json ./

# Install ALL dependencies (for building)
RUN npm install

COPY . .
RUN npm run build

# ============================================
# PRODUCTION STAGE
# ============================================
FROM node:18-alpine

WORKDIR /app

# Copy production dependencies from dependencies stage
COPY --from=dependencies /app/node_modules ./node_modules

# Copy built app from builder stage
COPY --from=builder /app/dist ./dist

COPY package.json ./

CMD ["node", "dist/index.js"]
```

**Visual Flow**:

```
DEPENDENCIES STAGE              BUILDER STAGE               PRODUCTION STAGE
(Production deps only)          (All deps for building)     (Final stage)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ npm ci --only=   â”‚           â”‚ npm install      â”‚        â”‚                  â”‚
â”‚ production       â”‚           â”‚                  â”‚        â”‚                  â”‚
â”‚                  â”‚           â”‚                  â”‚        â”‚                  â”‚
â”‚ node_modules/    â”‚           â”‚ node_modules/    â”‚        â”‚                  â”‚
â”‚   50 MB âœ“        â”‚â”€â”€â”€â”€â”€â”€â”    â”‚   500 MB         â”‚        â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚    â”‚                  â”‚        â”‚                  â”‚
                          â”‚    â”‚ Build app        â”‚        â”‚                  â”‚
                          â”‚    â”‚      â†“           â”‚        â”‚                  â”‚
                          â”‚    â”‚ dist/ âœ“          â”‚â”€â”€â”€â”    â”‚                  â”‚
                          â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚                  â”‚
                          â”‚                           â”‚    â”‚                  â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                  â”‚
                                         â”‚                 â”‚                  â”‚
                          Copy production deps    Copy built app              â”‚
                                         â”‚                 â”‚                  â”‚
                                         â–¼                 â–¼                  â”‚
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
                                    â”‚ /app/                        â”‚          â”‚
                                    â”‚  â”œâ”€â”€ node_modules/ (50 MB) âœ“ â”‚          â”‚
                                    â”‚  â””â”€â”€ dist/ âœ“                 â”‚          â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
                                                                              â”‚
                          Both builder and dependencies stages DELETED ğŸ—‘ï¸     â”‚
```

### Python Dependencies Example

Python has a similar pattern with pip:

```dockerfile
# ============================================
# BUILDER STAGE
# ============================================
FROM python:3.11 AS builder

WORKDIR /build

# Copy requirements
COPY requirements.txt .

# Install dependencies and create wheel files
RUN pip wheel --no-cache-dir --no-deps --wheel-dir /build/wheels \
    -r requirements.txt

# Wheels are pre-compiled packages (faster to install)
# Stored in: /build/wheels/

# ============================================
# PRODUCTION STAGE
# ============================================
FROM python:3.11-slim

WORKDIR /app

# Copy wheel files from builder
COPY --from=builder /build/wheels /wheels
COPY requirements.txt .

# Install from wheel files (fast!)
RUN pip install --no-cache-dir --no-index --find-links=/wheels \
    -r requirements.txt

# Clean up wheels after installation
RUN rm -rf /wheels

COPY . .

CMD ["python", "app.py"]
```

**What Happens**:

```
BUILDER STAGE:
1. pip wheel creates pre-compiled packages
   /build/wheels/
     â”œâ”€â”€ flask-2.3.0-py3-none-any.whl
     â”œâ”€â”€ requests-2.31.0-py3-none-any.whl
     â””â”€â”€ ... (all dependencies as wheels)
   
2. Also includes build tools (gcc, etc.) for compilation
   Total: 800 MB

[DELETED ğŸ—‘ï¸]

PRODUCTION STAGE:
1. Copy only wheel files (50 MB)
2. Install from wheels (fast, no compilation)
3. Delete wheels after install
4. Final size: 200 MB

Savings: 800 MB â†’ 200 MB (75% reduction!)
```

---

## Base Images in Multi-Stage Builds {#base-images}

One of the most powerful aspects of multi-stage builds is using DIFFERENT base images for different stages. This is like using different tools for different jobs.

### Why Different Base Images?

```
Building Stage Needs:           Production Stage Needs:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ“ Compilers (gcc, g++)          âœ— No compilers needed
âœ“ Build tools (make, cmake)     âœ— No build tools needed
âœ“ Development libraries         âœ“ Only runtime libraries
âœ“ Full OS utilities             âœ“ Minimal OS
âœ“ Package managers              âœ— No package manager needed
âœ“ Debugging tools               âœ— No debugging in production

Size: 500-1000 MB               Size: 50-200 MB
```

### Example: Full Image â†’ Slim Image

```dockerfile
# ============================================
# BUILDER: Use FULL Node.js image
# ============================================
FROM node:18 AS builder
# Full image includes:
# - Debian OS (complete)
# - Node.js + npm
# - Python (for node-gyp)
# - gcc, g++, make
# - git, curl, wget
# Total: 900 MB

WORKDIR /app

COPY package*.json ./
RUN npm install

COPY . .
RUN npm run build

# ============================================
# PRODUCTION: Use SLIM Node.js image
# ============================================
FROM node:18-slim
# Slim image includes:
# - Debian OS (minimal)
# - Node.js + npm only
# - NO build tools
# - NO extra utilities
# Total: 150 MB

WORKDIR /app

COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules

CMD ["node", "dist/index.js"]
```

**Size Comparison**:

```
If we used node:18 for both stages:
Builder stage: 900 MB (needed for building)
Production stage: 900 MB (wasted space) âš ï¸
Total final image: 900 MB

Using node:18 + node:18-slim:
Builder stage: 900 MB (needed, then deleted ğŸ—‘ï¸)
Production stage: 150 MB (optimal!) âœ“
Total final image: 150 MB

Savings: 750 MB (83% reduction!)
```

### Example: Full Image â†’ Alpine

Alpine Linux is even smaller:

```dockerfile
# ============================================
# BUILDER: Use standard image
# ============================================
FROM node:18 AS builder
# Standard Debian-based: 900 MB

WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

# ============================================
# PRODUCTION: Use Alpine
# ============================================
FROM node:18-alpine
# Alpine-based: 50 MB base

WORKDIR /app

COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules

CMD ["node", "dist/index.js"]
```

**Size Comparison**:

```
Builder Stage: node:18 (Debian)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Base OS: Debian         400 MB      â”‚
â”‚ Node.js + npm           200 MB      â”‚
â”‚ Build tools             200 MB      â”‚
â”‚ System utilities        100 MB      â”‚
â”‚                                     â”‚
â”‚ Total: 900 MB                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“ Build application
        â†“ Then DELETE ğŸ—‘ï¸

Production Stage: node:18-alpine
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Base OS: Alpine Linux    7 MB       â”‚
â”‚ Node.js + npm           40 MB       â”‚
â”‚ App files (copied)       3 MB       â”‚
â”‚                                     â”‚
â”‚ Total: 50 MB                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Final image: 50 MB (94% smaller!)
```

### Example: Standard â†’ Distroless

Distroless is even more minimal (no shell, no package manager):

```dockerfile
# ============================================
# BUILDER: Use standard Go image
# ============================================
FROM golang:1.21 AS builder
# Standard image: 800 MB

WORKDIR /app

COPY go.mod go.sum ./
RUN go mod download

COPY . .

# Build static binary
RUN CGO_ENABLED=0 GOOS=linux go build -o app .

# ============================================
# PRODUCTION: Use Distroless
# ============================================
FROM gcr.io/distroless/static-debian11
# Distroless: 2 MB base (almost nothing!)

COPY --from=builder /app/app /app

ENTRYPOINT ["/app"]
```

**What's in Each Image**:

```
golang:1.21 (Builder)             distroless (Production)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Debian OS (full)            â”‚   â”‚ ONLY:                       â”‚
â”‚ Go compiler                 â”‚   â”‚ - Your application binary   â”‚
â”‚ Go tools                    â”‚   â”‚ - Minimal C library         â”‚
â”‚ gcc, make, git              â”‚   â”‚ - SSL certificates          â”‚
â”‚ Shell (bash)                â”‚   â”‚                             â”‚
â”‚ Package manager (apt)       â”‚   â”‚ NO shell âœ—                  â”‚
â”‚ System utilities            â”‚   â”‚ NO package manager âœ—        â”‚
â”‚                             â”‚   â”‚ NO utilities âœ—              â”‚
â”‚ Total: 800 MB               â”‚   â”‚                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ Total: 5 MB (app + base)    â”‚
        â†“ DELETED ğŸ—‘ï¸              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Example: Standard â†’ Scratch

Scratch is completely empty (0 bytes):

```dockerfile
# ============================================
# BUILDER
# ============================================
FROM golang:1.21-alpine AS builder

WORKDIR /app

COPY . .

# Build completely static binary (no dependencies)
RUN CGO_ENABLED=0 GOOS=linux go build \
    -ldflags='-w -s -extldflags "-static"' \
    -o app .

# ============================================
# PRODUCTION: Scratch (empty image)
# ============================================
FROM scratch

# Copy ONLY the binary
COPY --from=builder /app/app /app

# Copy SSL certificates (needed for HTTPS)
COPY --from=builder /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/

ENTRYPOINT ["/app"]
```

**What's in Scratch**:

```
FROM scratch
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Literally NOTHING                   â”‚
â”‚                                     â”‚
â”‚ Size: 0 bytes                       â”‚
â”‚                                     â”‚
â”‚ You add:                            â”‚
â”‚ âœ“ Your binary (5 MB)                â”‚
â”‚ âœ“ SSL certs (200 KB)                â”‚
â”‚                                     â”‚
â”‚ Total: 5.2 MB                       â”‚
â”‚                                     â”‚
â”‚ This is the smallest possible!      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Production Stage Optimization {#production-stage}

The production stage is what you keep, so optimizing it is crucial. Let's explore every optimization technique.

### Technique 1: Copy Only What's Needed

**Bad: Copy Everything**

```dockerfile
FROM node:18 AS builder
WORKDIR /app
COPY . .
RUN npm install
RUN npm run build

FROM node:18-alpine
WORKDIR /app
# âŒ BAD: Copy everything from builder
COPY --from=builder /app ./
# This includes src/, tests/, node_modules/, etc.
```

**Good: Copy Selectively**

```dockerfile
FROM node:18 AS builder
WORKDIR /app
COPY . .
RUN npm install
RUN npm run build

FROM node:18-alpine
WORKDIR /app
# âœ… GOOD: Copy only what's needed
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./
# Only dist/, node_modules/, and package.json
```

**Size Difference**:

```
Copy Everything:
/app/
  â”œâ”€â”€ src/             (20 MB) âš ï¸ Not needed
  â”œâ”€â”€ tests/           (10 MB) âš ï¸ Not needed
  â”œâ”€â”€ build-scripts/   (5 MB) âš ï¸ Not needed
  â”œâ”€â”€ node_modules/    (500 MB)
  â”œâ”€â”€ dist/            (5 MB) âœ“ Needed
  â””â”€â”€ package.json     (2 KB) âœ“ Needed
Total: 540 MB

Copy Selectively:
/app/
  â”œâ”€â”€ node_modules/    (500 MB)
  â”œâ”€â”€ dist/            (5 MB) âœ“
  â””â”€â”€ package.json     (2 KB) âœ“
Total: 505 MB

Already better, but node_modules still big!
```

### Technique 2: Reinstall Production Dependencies

Instead of copying node_modules, reinstall only production deps:

```dockerfile
FROM node:18 AS builder
WORKDIR /app
COPY package*.json ./
RUN npm install  # All dependencies
COPY . .
RUN npm run build

FROM node:18-alpine
WORKDIR /app

# âœ… Copy package files and reinstall
COPY package.json package-lock.json ./
RUN npm ci --only=production && npm cache clean --force

# Copy built app
COPY --from=builder /app/dist ./dist

CMD ["node", "dist/index.js"]
```

**Size Difference**:

```
Method 1: Copy node_modules from builder
node_modules: 500 MB (includes dev dependencies)

Method 2: Reinstall with --only=production
node_modules: 50 MB (only production dependencies)

Savings: 450 MB (90% reduction!)
```

### Technique 3: Clean Up After Copy

```dockerfile
FROM python:3.11 AS builder
WORKDIR /build
COPY requirements.txt .
RUN pip wheel --wheel-dir /wheels -r requirements.txt

FROM python:3.11-slim
WORKDIR /app

# Copy wheels
COPY --from=builder /wheels /wheels
COPY requirements.txt .

# Install from wheels
RUN pip install --no-cache-dir --no-index --find-links=/wheels \
    -r requirements.txt

# âœ… CLEAN UP: Remove wheels after installation
RUN rm -rf /wheels

COPY . .
CMD ["python", "app.py"]
```

**What Happens**:

```
Step 1: Copy wheels
/wheels/  = 50 MB

Step 2: Install from wheels
/usr/local/lib/python3.11/site-packages/ = 200 MB

Step 3: Remove wheels
/wheels/ = DELETED âœ“

Final: Only installed packages (200 MB)
If we didn't delete wheels: 250 MB
Savings: 50 MB
```

### Technique 4: Use Minimal Base Image

```dockerfile
# Stage 1: Build with full image
FROM python:3.11 AS builder
# ...build steps...

# Stage 2: Use minimal image
FROM python:3.11-slim
# or even better:
FROM python:3.11-alpine
# or smallest:
FROM gcr.io/distroless/python3
```

**Size Comparison**:

```
python:3.11         = 900 MB base
python:3.11-slim    = 120 MB base (87% smaller)
python:3.11-alpine  = 50 MB base (94% smaller)
distroless/python3  = 50 MB base (94% smaller)
```

### Technique 5: Remove Build Dependencies

```dockerfile
FROM python:3.11-slim AS builder
# Install build dependencies
RUN apt-get update && apt-get install -y gcc
COPY requirements.txt .
RUN pip wheel --wheel-dir /wheels -r requirements.txt

FROM python:3.11-slim
# âœ… NO build dependencies in production
# Only runtime dependencies if needed
RUN apt-get update && apt-get install -y libpq5 && \
    rm -rf /var/lib/apt/lists/*

COPY --from=builder /wheels /wheels
RUN pip install --no-index --find-links=/wheels -r requirements.txt && \
    rm -rf /wheels
```

**Comparison**:

```
With build dependencies:
gcc: 100 MB âš ï¸
python3-dev: 50 MB âš ï¸
make: 10 MB âš ï¸
Total: 160 MB not needed!

Without build dependencies (multi-stage):
libpq5: 1 MB (runtime lib) âœ“
Total: 1 MB

Savings: 159 MB
```

### Technique 6: Combine Multiple Optimizations

```dockerfile
# ============================================
# BUILDER STAGE: Use full-featured image
# ============================================
FROM node:18 AS builder

WORKDIR /app

# Install dependencies
COPY package.json package-lock.json ./
RUN npm install

# Build application
COPY src/ ./src/
COPY tsconfig.json webpack.config.js ./
RUN npm run build

# Builder contains:
# - Source code (src/)
# - All dependencies (node_modules/)
# - Build configs
# - Built output (dist/)
# Total: 900 MB

# ============================================
# PRODUCTION STAGE: Optimized
# ============================================
FROM node:18-alpine

# 1. Minimal base (Alpine instead of Debian)
# 2. Create non-root user (security)
RUN adduser -D appuser

WORKDIR /app

# 3. Copy only package files and reinstall production deps
COPY package.json package-lock.json ./
RUN npm ci --only=production && \
    npm cache clean --force

# 4. Copy only built output (not source)
COPY --from=builder /app/dist ./dist

# 5. Set ownership
RUN chown -R appuser:appuser /app

# 6. Run as non-root
USER appuser

# 7. Expose port
EXPOSE 3000

# 8. Health check
HEALTHCHECK CMD wget --spider http://localhost:3000/health || exit 1

CMD ["node", "dist/index.js"]

# Final image:
# - Alpine base: 50 MB
# - Production deps: 50 MB  
# - Built app: 5 MB
# Total: 105 MB (88% smaller than builder!)
```

---

## Complete Step-by-Step Example {#complete-example}

Let's build a complete example from scratch, explaining every single line and what happens in memory.

### The Application

We have a simple Node.js application:

**Project Structure**:

```
my-app/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.js          (main application)
â”‚   â”œâ”€â”€ routes.js         (route definitions)
â”‚   â”œâ”€â”€ database.js       (database connection)
â”‚   â””â”€â”€ utils.js          (helper functions)
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ index.test.js
â”‚   â””â”€â”€ routes.test.js
â”œâ”€â”€ package.json
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ webpack.config.js
â””â”€â”€ Dockerfile
```

**package.json**:

```json
{
  "dependencies": {
    "express": "^4.18.2",
    "pg": "^8.11.0"
  },
  "devDependencies": {
    "webpack": "^5.88.0",
    "webpack-cli": "^5.1.4",
    "babel-loader": "^9.1.3",
    "@babel/core": "^7.22.0",
    "@babel/preset-env": "^7.22.0",
    "jest": "^29.5.0",
    "eslint": "^8.43.0"
  }
}
```

### Step-by-Step Dockerfile Creation

```dockerfile
# ============================================
# STAGE 1: BUILDER
# Purpose: Build the application with all tools
# ============================================

# Step 1: Choose base image for building
FROM node:18 AS builder
#      ^^^^^^^ Use full Node.js image (has all build tools)
#              ^^^ Name this stage "builder"

# What's in memory now:
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ node:18 base image loaded           â”‚
# â”‚ - Debian OS (minimal)               â”‚
# â”‚ - Node.js 18                        â”‚
# â”‚ - npm package manager               â”‚
# â”‚ - Basic system utilities            â”‚
# â”‚ Size: ~900 MB                       â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

# Step 2: Set working directory
WORKDIR /app

# What's in memory now:
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ node:18 base image                  â”‚
# â”‚ â””â”€ /app/ directory created          â”‚
# â”‚    (empty)                          â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

# Step 3: Copy package files FIRST (for caching)
COPY package.json package-lock.json ./

# What's in memory now:
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ /app/                               â”‚
# â”‚  â”œâ”€â”€ package.json (2 KB)            â”‚
# â”‚  â””â”€â”€ package-lock.json (50 KB)      â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
# 
# Why copy these first?
# - If these files don't change, next step uses cache
# - Saves time on rebuilds!

# Step 4: Install ALL dependencies
RUN npm install

# What happens:
# 1. npm reads package.json
# 2. Downloads all packages (production + dev)
# 3. Installs to node_modules/
# 4. Creates package-lock.json if needed
#
# What's in memory now:
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ /app/                               â”‚
# â”‚  â”œâ”€â”€ package.json                   â”‚
# â”‚  â”œâ”€â”€ package-lock.json              â”‚
# â”‚  â””â”€â”€ node_modules/ (500 MB!)        â”‚
# â”‚       â”œâ”€â”€ express/ (production)     â”‚
# â”‚       â”œâ”€â”€ pg/ (production)          â”‚
# â”‚       â”œâ”€â”€ webpack/ (dev) âš ï¸         â”‚
# â”‚       â”œâ”€â”€ babel-loader/ (dev) âš ï¸    â”‚
# â”‚       â”œâ”€â”€ jest/ (dev) âš ï¸            â”‚
# â”‚       â””â”€â”€ eslint/ (dev) âš ï¸          â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
# Total added: 500 MB

# Step 5: Copy source code
COPY src/ ./src/
COPY tsconfig.json webpack.config.js ./

# What's in memory now:
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ /app/                               â”‚
# â”‚  â”œâ”€â”€ package.json                   â”‚
# â”‚  â”œâ”€â”€ package-lock.json              â”‚
# â”‚  â”œâ”€â”€ node_modules/ (500 MB)         â”‚
# â”‚  â”œâ”€â”€ src/ (20 KB)                   â”‚
# â”‚  â”‚    â”œâ”€â”€ index.js                  â”‚
# â”‚  â”‚    â”œâ”€â”€ routes.js                 â”‚
# â”‚  â”‚    â”œâ”€â”€ database.js               â”‚
# â”‚  â”‚    â””â”€â”€ utils.js                  â”‚
# â”‚  â”œâ”€â”€ tsconfig.json                  â”‚
# â”‚  â””â”€â”€ webpack.config.js              â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

# Step 6: Build the application
RUN npm run build

# What happens:
# 1. webpack reads webpack.config.js
# 2. Processes src/ files with babel
# 3. Bundles everything into dist/
# 4. Minifies and optimizes
#
# What's in memory now:
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ /app/                               â”‚
# â”‚  â”œâ”€â”€ package.json                   â”‚
# â”‚  â”œâ”€â”€ package-lock.json              â”‚
# â”‚  â”œâ”€â”€ node_modules/ (500 MB)         â”‚
# â”‚  â”œâ”€â”€ src/ (20 KB)                   â”‚
# â”‚  â”œâ”€â”€ tsconfig.json                  â”‚
# â”‚  â”œâ”€â”€ webpack.config.js              â”‚
# â”‚  â””â”€â”€ dist/ (5 MB) âœ“ THIS IS WHAT WE WANT!
# â”‚       â”œâ”€â”€ bundle.js                 â”‚
# â”‚       â”œâ”€â”€ bundle.js.map             â”‚
# â”‚       â””â”€â”€ assets/                   â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# Builder stage total size: ~900 MB
# What we actually need: 5 MB (just dist/)
# Waste: 895 MB (99.4%!)

# ============================================
# STAGE 2: PRODUCTION
# Purpose: Run the application with minimal size
# ============================================

# Step 7: Start fresh with Alpine (smaller base)
FROM node:18-alpine
#      ^^^^^^^^^^^^^^ Alpine is much smaller than Debian
# No AS name needed (this is the final stage)

# What's in memory now:
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ node:18-alpine base image           â”‚
# â”‚ - Alpine Linux (tiny!)              â”‚
# â”‚ - Node.js 18                        â”‚
# â”‚ - npm package manager               â”‚
# â”‚ Size: ~50 MB (vs 900 MB before!)    â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# IMPORTANT: This is a COMPLETELY NEW stage
# The builder stage still exists in memory, but
# this production stage starts totally fresh!

# Step 8: Create non-root user (security)
RUN adduser -D appuser

# What's in memory:
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ User created:                       â”‚
# â”‚ - Username: appuser                 â”‚
# â”‚ - UID: 1000 (or similar)            â”‚
# â”‚ - Home: /home/appuser               â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

# Step 9: Set working directory
WORKDIR /app

# Creates /app/ directory in THIS stage

# Step 10: Copy package files
COPY package.json package-lock.json ./

# What's in memory now:
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ /app/                               â”‚
# â”‚  â”œâ”€â”€ package.json                   â”‚
# â”‚  â””â”€â”€ package-lock.json              â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

# Step 11: Install ONLY production dependencies
RUN npm ci --only=production && \
    npm cache clean --force

# What happens:
# 1. npm ci reads package-lock.json
# 2. Installs ONLY production dependencies
# 3. Skips all devDependencies
# 4. Cleans npm cache
#
# What's in memory now:
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ /app/                               â”‚
# â”‚  â”œâ”€â”€ package.json                   â”‚
# â”‚  â”œâ”€â”€ package-lock.json              â”‚
# â”‚  â””â”€â”€ node_modules/ (50 MB)          â”‚
# â”‚       â”œâ”€â”€ express/ âœ“                â”‚
# â”‚       â””â”€â”€ pg/ âœ“                     â”‚
# â”‚       (NO webpack, babel, jest!)    â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# Size: 50 MB (vs 500 MB in builder!)

# Step 12: Copy ONLY the built application
COPY --from=builder /app/dist ./dist
#           ^^^^^^^ From the builder stage
#                   ^^^^^^^^^ Copy this directory
#                                    ^^^^^^ To this location

# This is the MAGIC step!
# Docker reaches into the builder stage,
# grabs ONLY /app/dist,
# and copies it to current stage

# What's in memory now:
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ /app/                               â”‚
# â”‚  â”œâ”€â”€ package.json                   â”‚
# â”‚  â”œâ”€â”€ package-lock.json              â”‚
# â”‚  â”œâ”€â”€ node_modules/ (50 MB)          â”‚
# â”‚  â””â”€â”€ dist/ (5 MB) âœ“                 â”‚
# â”‚       â”œâ”€â”€ bundle.js                 â”‚
# â”‚       â”œâ”€â”€ bundle.js.map             â”‚
# â”‚       â””â”€â”€ assets/                   â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# NOTICE: src/, webpack.config.js, tests/
# are NOT here! They stayed in builder stage!

# Step 13: Change ownership
RUN chown -R appuser:appuser /app

# All files in /app now owned by appuser

# Step 14: Switch to non-root user
USER appuser

# All subsequent commands run as appuser

# Step 15: Document the port
EXPOSE 3000

# This doesn't actually expose the port,
# just documents it for users

# Step 16: Add health check
HEALTHCHECK --interval=30s --timeout=3s \
    CMD node healthcheck.js || exit 1

# Docker will run this command periodically

# Step 17: Set startup command
CMD ["node", "dist/index.js"]

# When container starts, run this command

# ============================================
# FINAL MEMORY STATE
# ============================================

# Builder stage (DELETED after build):
# Size: 900 MB
# Contents: Everything (src, node_modules, dist, configs)
#
# Production stage (KEPT):
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ Alpine base:        50 MB           â”‚
# â”‚ node_modules/:      50 MB           â”‚
# â”‚ dist/:               5 MB           â”‚
# â”‚ package files:     0.1 MB           â”‚
# â”‚                                     â”‚
# â”‚ TOTAL:           105.1 MB           â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# Reduction: 900 MB â†’ 105 MB (88% smaller!)
```

### Visual Memory Flow

```
BUILD TIME:

Stage 1: BUILDER (node:18)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Memory Space: 900 MB                          â”‚
â”‚                                               â”‚
â”‚ /app/                                         â”‚
â”‚  â”œâ”€â”€ src/              20 KB                  â”‚
â”‚  â”œâ”€â”€ node_modules/    500 MB âš ï¸               â”‚
â”‚  â”œâ”€â”€ configs           10 KB                  â”‚
â”‚  â””â”€â”€ dist/              5 MB âœ“                â”‚
â”‚                                               â”‚
â”‚ This stage builds everything                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ Copy ONLY dist/ â¬‡ï¸
        â”‚
Stage 2: PRODUCTION (node:18-alpine)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Memory Space: 105 MB                          â”‚
â”‚                                               â”‚
â”‚ /app/                                         â”‚
â”‚  â”œâ”€â”€ node_modules/     50 MB âœ“ (prod only)    â”‚
â”‚  â””â”€â”€ dist/              5 MB âœ“ (from builder) â”‚
â”‚                                               â”‚
â”‚ This stage runs in production                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

AFTER BUILD:

Builder stage: DELETED ğŸ—‘ï¸ (frees 900 MB)
Production stage: KEPT âœ“ (only 105 MB)

Final Docker Image saved to disk: 105 MB
```

---

## Memory and Size Reduction Explained {#size-reduction}

Let's dive deep into exactly HOW multi-stage builds reduce size, with detailed memory diagrams.

### How Docker Images Are Stored on Disk

Docker images are stored as a collection of layers. Think of it like a stack of transparent sheets:

```
Docker Image Storage:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Image Name: myapp:latest            â”‚
â”‚                                     â”‚
â”‚ Layers (stacked):                   â”‚
â”‚                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Layer 5: CMD [...]              â”‚ â”‚ 0 bytes
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ Layer 4: USER appuser           â”‚ â”‚ 0 bytes
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ Layer 3: COPY dist/             â”‚ â”‚ 5 MB
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ Layer 2: RUN npm install        â”‚ â”‚ 50 MB
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ Layer 1: FROM node:18-alpine    â”‚ â”‚ 50 MB
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                     â”‚
â”‚ Total Size: 105 MB                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Stored on disk:
/var/lib/docker/overlay2/
  â”œâ”€â”€ layer-1-sha256-abc.../
  â”‚    â””â”€â”€ (50 MB - Alpine + Node.js)
  â”œâ”€â”€ layer-2-sha256-def.../
  â”‚    â””â”€â”€ (50 MB - node_modules/)
  â””â”€â”€ layer-3-sha256-ghi.../
       â””â”€â”€ (5 MB - dist/)

Each layer is stored separately
Docker combines them when running container
```

### Single-Stage: Everything Stays

```
SINGLE-STAGE DOCKERFILE:

FROM node:18
WORKDIR /app
COPY . .                    â† Layer 1: 20 MB (source code)
RUN npm install             â† Layer 2: 500 MB (all dependencies)
RUN npm run build           â† Layer 3: 5 MB (built output)
CMD ["node", "dist/index.js"]

LAYERS ON DISK:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 0: node:18 base   900 MB      â”‚ â† Debian + Node
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 1: COPY . .        20 MB      â”‚ â† Source code
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 2: npm install    500 MB âš ï¸   â”‚ â† All dependencies
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 3: npm build        5 MB      â”‚ â† Built output
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 4: CMD              0 MB      â”‚ â† Metadata
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Total on disk: 1,425 MB

When you push/pull this image:
Transfer: 1,425 MB âš ï¸
Storage: 1,425 MB per image
Deploy time: ~5-10 minutes on slow connection
```

### Multi-Stage: Intermediate Layers Discarded

```
MULTI-STAGE DOCKERFILE:

# BUILDER STAGE
FROM node:18 AS builder
WORKDIR /app
COPY . .
RUN npm install
RUN npm run build

# PRODUCTION STAGE
FROM node:18-alpine
COPY --from=builder /app/dist ./dist
RUN npm ci --only=production
CMD ["node", "dist/index.js"]

LAYERS CREATED DURING BUILD:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BUILDER STAGE LAYERS (temporary):   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 0: node:18 base   900 MB      â”‚
â”‚ Layer 1: COPY . .        20 MB      â”‚
â”‚ Layer 2: npm install    500 MB      â”‚
â”‚ Layer 3: npm build        5 MB      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ These layers are DISCARDED! ğŸ—‘ï¸

LAYERS SAVED TO FINAL IMAGE:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 0: node:18-alpine  50 MB      â”‚ â† Smaller base
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 1: COPY dist/       5 MB      â”‚ â† Only built output
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 2: npm ci prod     50 MB      â”‚ â† Only prod deps
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 3: CMD              0 MB      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Total on disk: 105 MB âœ“

When you push/pull this image:
Transfer: 105 MB (93% less!)
Storage: 105 MB per image
Deploy time: ~30 seconds

BUILDER LAYERS: Created in memory during build, then deleted
FINAL LAYERS: Saved to disk as the image
```

### Size Reduction Breakdown

Let's break down exactly where the savings come from:

```
SINGLE-STAGE SIZE BREAKDOWN:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Component              â”‚ Size    â”‚ Needed?  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Base OS (Debian)       â”‚ 400 MB  â”‚âš ï¸Too big â”‚
â”‚ Node.js + npm          â”‚ 200 MB  â”‚ âœ“ Yes    â”‚
â”‚ System utilities       â”‚ 100 MB  â”‚ âš ï¸ No    â”‚
â”‚ Build tools            â”‚ 200 MB  â”‚ âš ï¸ No    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Source code (src/)     â”‚  20 MB  â”‚ âš ï¸ No    â”‚
â”‚ Tests (tests/)         â”‚  10 MB  â”‚ âš ï¸ No    â”‚
â”‚ Build configs          â”‚  10 MB  â”‚ âš ï¸ No    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Dev dependencies       â”‚ 450 MB  â”‚ âš ï¸ No    â”‚
â”‚ Production deps        â”‚  50 MB  â”‚ âœ“ Yes    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Built output (dist/)   â”‚   5 MB  â”‚ âœ“ Yes    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ TOTAL                  â”‚1,445 MB â”‚          â”‚
â”‚ Actually needed        â”‚ 255 MB  â”‚          â”‚
â”‚ Waste                  â”‚1,190 MB â”‚ 82%!     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

MULTI-STAGE SIZE BREAKDOWN:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Component              â”‚ Size    â”‚ Included?â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Base OS (Alpine)       â”‚   7 MB  â”‚ âœ“ Minimalâ”‚
â”‚ Node.js + npm          â”‚  43 MB  â”‚ âœ“ Yes    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Production deps only   â”‚  50 MB  â”‚ âœ“ Yes    â”‚
â”‚ Built output (dist/)   â”‚   5 MB  â”‚ âœ“ Yes    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ TOTAL                  â”‚ 105 MB  â”‚          â”‚
â”‚ Everything needed      â”‚ 105 MB  â”‚ âœ“        â”‚
â”‚ Nothing wasted         â”‚   0 MB  â”‚ 0%!      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Reduction: 1,445 MB â†’ 105 MB
Savings: 1,340 MB (93% smaller!)
```

### Memory During Build Process

```
BUILD PROCESS MEMORY USAGE:

Time 0: Build starts
â”œâ”€ Memory: 0 MB

Time 1: Load builder base image
â”œâ”€ Memory: 900 MB (node:18)

Time 2: Copy files to builder
â”œâ”€ Memory: 920 MB (900 + 20)

Time 3: Install dependencies in builder
â”œâ”€ Memory: 1,420 MB (920 + 500)

Time 4: Build application in builder
â”œâ”€ Memory: 1,425 MB (1,420 + 5)

Time 5: Start production stage
â”œâ”€ Memory: 1,425 MB (builder still in memory)
â”œâ”€ Memory: 1,475 MB (+ 50 Alpine base)

Time 6: Copy from builder to production
â”œâ”€ Memory: 1,480 MB (1,475 + 5 for dist)

Time 7: Install prod deps in production
â”œâ”€ Memory: 1,530 MB (1,480 + 50)

Time 8: Build complete!
â”œâ”€ Delete builder stage: FREE 1,425 MB ğŸ—‘ï¸
â”œâ”€ Keep production stage: 105 MB âœ“
â”œâ”€ Final memory: 105 MB

Maximum memory during build: 1,530 MB
Final image size: 105 MB
Memory freed after build: 1,425 MB
```

### Why Builder Stage Gets Deleted

Docker only keeps the FINAL stage in the image:

```
HOW DOCKER DECIDES WHAT TO KEEP:

Multi-stage Dockerfile:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FROM node:18 AS builder             â”‚ â† Stage 1
â”‚ ... (build commands)                â”‚
â”‚                                     â”‚
â”‚ FROM node:18-alpine                 â”‚ â† Stage 2 (FINAL)
â”‚ COPY --from=builder ...             â”‚
â”‚ ... (production commands)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Docker's logic:
1. Build all stages in order
2. Each stage creates layers
3. When build finishes:
   - Look at the LAST stage (stage 2)
   - This is the "final" stage
   - Save only this stage's layers to image
   - DELETE all other stages' layers

Result:
- Stage 1 (builder): DELETED ğŸ—‘ï¸
- Stage 2 (production): SAVED âœ“

The only exception:
- If you build with --target flag:
  docker build --target builder -t myapp:builder .
  Then builder stage is saved instead
```

### Layer Sharing and Deduplication

Docker is smart about layer storage:

```
SCENARIO: Multiple images using same base

Image 1: myapp:latest
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 0: node:18-alpine  50 MB      â”‚ â† Shared
â”‚ Layer 1: App code        55 MB      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Image 2: myapp:v2
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 0: node:18-alpine  50 MB      â”‚ â† Same! Shared
â”‚ Layer 1: Updated code    56 MB      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Image 3: otherapp:latest
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 0: node:18-alpine  50 MB      â”‚ â† Same! Shared
â”‚ Layer 1: Different app   40 MB      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Storage calculation:
WITHOUT deduplication:
  Image 1: 105 MB
  Image 2: 106 MB
  Image 3:  90 MB
  Total:   301 MB

WITH deduplication (actual):
  Shared layer (node:18-alpine): 50 MB (stored once)
  Image 1 unique layers: 55 MB
  Image 2 unique layers: 56 MB
  Image 3 unique layers: 40 MB
  Total: 50 + 55 + 56 + 40 = 201 MB âœ“

Savings: 100 MB through layer sharing!
```

---

## Advanced Patterns {#advanced-patterns}

### Pattern 1: Multiple Parallel Build Stages

You can build multiple things in parallel:

```dockerfile
# ============================================
# Build frontend (can run in parallel)
# ============================================
FROM node:18 AS frontend-builder

WORKDIR /frontend

COPY frontend/package*.json ./
RUN npm install

COPY frontend/src ./src
COPY frontend/public ./public
RUN npm run build
# Output: /frontend/build/

# ============================================
# Build backend (can run in parallel)
# ============================================
FROM node:18 AS backend-builder

WORKDIR /backend

COPY backend/package*.json ./
RUN npm install

COPY backend/src ./src
RUN npm run build
# Output: /backend/dist/

# ============================================
# Build documentation (can run in parallel)
# ============================================
FROM node:18 AS docs-builder

WORKDIR /docs

COPY docs/package*.json ./
RUN npm install

COPY docs/ ./
RUN npm run build
# Output: /docs/build/

# ============================================
# Production: Combine all builds
# ============================================
FROM node:18-alpine

WORKDIR /app

# Install production dependencies
COPY backend/package*.json ./
RUN npm ci --only=production

# Copy backend
COPY --from=backend-builder /backend/dist ./api

# Copy frontend
COPY --from=frontend-builder /frontend/build ./public

# Copy docs
COPY --from=docs-builder /docs/build ./docs

CMD ["node", "api/index.js"]
```

**Parallel Build Visualization**:

```
BUILD TIME WITH BUILDKIT:

All three build stages run SIMULTANEOUSLY:

Frontend-builder    Backend-builder    Docs-builder
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ npm installâ”‚     â”‚ npm installâ”‚     â”‚ npm installâ”‚
â”‚ npm build  â”‚     â”‚ npm build  â”‚     â”‚ npm build  â”‚
â”‚ (2 min)    â”‚     â”‚ (3 min)    â”‚     â”‚ (1 min)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                  â”‚                   â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
              Production stage builds
                    (1 min)

Total time: ~4 minutes
(vs ~7 minutes if sequential)
```

### Pattern 2: Dependency Caching Stage

```dockerfile
# ============================================
# Stage 1: Cache dependencies separately
# ============================================
FROM python:3.11 AS dependencies

WORKDIR /deps

# Install production dependencies
COPY requirements-prod.txt .
RUN pip install --user --no-cache-dir -r requirements-prod.txt

# ============================================
# Stage 2: Build with dev dependencies
# ============================================
FROM python:3.11 AS builder

WORKDIR /build

# Install dev dependencies
COPY requirements-dev.txt .
RUN pip install --no-cache-dir -r requirements-dev.txt

# Copy source and build
COPY . .
RUN python setup.py build

# ============================================
# Stage 3: Production
# ============================================
FROM python:3.11-slim

WORKDIR /app

# Copy production dependencies from cache stage
COPY --from=dependencies /root/.local /root/.local

# Copy built application
COPY --from=builder /build/dist ./dist

# Make sure scripts are in PATH
ENV PATH=/root/.local/bin:$PATH

CMD ["python", "dist/app.py"]
```

**Why This Pattern**:

```
REBUILD SCENARIO: Code changed, dependencies didn't

Stage 1 (dependencies): CACHED âœ“ (no rebuild)
Stage 2 (builder): REBUILD (code changed)
Stage 3 (production): REBUILD (uses cached stage 1)

Time saved: ~5 minutes on dependency installation!
```

### Pattern 3: Test Stage (Fail Fast)

```dockerfile
# ============================================
# Stage 1: Dependencies
# ============================================
FROM node:18 AS dependencies

WORKDIR /app

COPY package*.json ./
RUN npm install

# ============================================
# Stage 2: Test (Fail early if tests fail!)
# ============================================
FROM node:18 AS test

WORKDIR /app

# Copy dependencies from previous stage
COPY --from=dependencies /app/node_modules ./node_modules

# Copy source code
COPY . .

# Run tests - BUILD FAILS if tests fail!
RUN npm test
RUN npm run lint

# ============================================
# Stage 3: Build (Only if tests passed)
# ============================================
FROM node:18 AS builder

WORKDIR /app

COPY --from=dependencies /app/node_modules ./node_modules
COPY . .

RUN npm run build

# ============================================
# Stage 4: Production (Only if build succeeded)
# ============================================
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY --from=builder /app/dist ./dist

CMD ["node", "dist/index.js"]
```

**Build Flow**:

```
Build starts
    â†“
Install dependencies (Stage 1)
    â†“
Run tests (Stage 2)
    â†“
  Tests pass? â”€â”€â”€â”€â”€Noâ”€â”€â†’ BUILD FAILS âœ—
    â†“ Yes                 (Stop here)
    â†“
Build application (Stage 3)
    â†“
Create production image (Stage 4)
    â†“
BUILD SUCCESS âœ“
```

---

## Real-World Scenarios {#real-world-scenarios}

### Scenario 1: React + Express Full-Stack Application

**Application Structure**:

```
myapp/
â”œâ”€â”€ frontend/          (React app)
â”‚   â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ public/
â”‚   â””â”€â”€ package.json
â”œâ”€â”€ backend/           (Express API)
â”‚   â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ tests/
â”‚   â””â”€â”€ package.json
â””â”€â”€ Dockerfile
```

**Complete Dockerfile**:

```dockerfile
# ============================================
# Stage 1: Build Frontend
# ============================================
FROM node:18 AS frontend-builder

WORKDIR /frontend

# Install frontend dependencies
COPY frontend/package*.json ./
RUN npm ci

# Build frontend
COPY frontend/src ./src
COPY frontend/public ./public
COPY frontend/tsconfig.json ./
RUN npm run build

# Output: /frontend/build/ (static files: 2 MB)

# ============================================
# Stage 2: Build Backend
# ============================================
FROM node:18 AS backend-builder

WORKDIR /backend

# Install all dependencies (for building)
COPY backend/package*.json ./
RUN npm install

# Build backend TypeScript
COPY backend/src ./src
COPY backend/tsconfig.json ./
RUN npm run build

# Output: /backend/dist/ (compiled JS: 1 MB)

# ============================================
# Stage 3: Production
# ============================================
FROM node:18-alpine

# Create non-root user
RUN adduser -D appuser

WORKDIR /app

# Install ONLY production dependencies for backend
COPY backend/package*.json ./
RUN npm ci --only=production && \
    npm cache clean --force

# Copy compiled backend
COPY --from=backend-builder /backend/dist ./api

# Copy static frontend files
COPY --from=frontend-builder /frontend/build ./public

# Set ownership
RUN chown -R appuser:appuser /app

USER appuser

# Expose port
EXPOSE 3000

# Health check
HEALTHCHECK --interval=30s CMD wget --spider http://localhost:3000/health || exit 1

# Start server
CMD ["node", "api/server.js"]
```

**Size Analysis**:

```
WITHOUT multi-stage (single FROM node:18):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ node:18 base              900 MB        â”‚
â”‚ Frontend src + deps       600 MB        â”‚
â”‚ Backend src + deps        400 MB        â”‚
â”‚ Frontend build output       2 MB        â”‚
â”‚ Backend build output        1 MB        â”‚
â”‚                                         â”‚
â”‚ TOTAL                  1,903 MB         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

WITH multi-stage:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ node:18-alpine base        50 MB        â”‚
â”‚ Backend prod dependencies  30 MB        â”‚
â”‚ Frontend static files       2 MB        â”‚
â”‚ Backend compiled code       1 MB        â”‚
â”‚                                         â”‚
â”‚ TOTAL                      83 MB        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Reduction: 1,903 MB â†’ 83 MB (96% smaller!)

Deployment improvements:
- Docker pull: 30 seconds (was 10+ minutes)
- Storage cost: $0.10/month (was $2.00/month)
- Container startup: 2 seconds (was 10 seconds)
```

### Scenario 2: Python Django + PostgreSQL Application

```dockerfile
# ============================================
# Stage 1: Build Python wheels
# ============================================
FROM python:3.11 AS builder

# Install build dependencies
RUN apt-get update && apt-get install -y \
    gcc \
    postgresql-dev \
    python3-dev \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /build

# Install Python dependencies and create wheels
COPY requirements.txt .
RUN pip wheel --no-cache-dir --no-deps --wheel-dir /wheels \
    -r requirements.txt

# Build wheels saves compiled versions:
# /wheels/
#   â”œâ”€â”€ Django-4.2-py3-none-any.whl
#   â”œâ”€â”€ psycopg2-2.9.6-cp311-linux_x86_64.whl
#   â””â”€â”€ ... (all other packages)

# ============================================
# Stage 2: Production
# ============================================
FROM python:3.11-slim

# Install ONLY runtime dependencies (not build tools!)
RUN apt-get update && apt-get install -y \
    libpq5 \
    && rm -rf /var/lib/apt/lists/*

# Create non-root user
RUN useradd -m -u 1000 django

WORKDIR /app

# Copy wheels from builder
COPY --from=builder /wheels /wheels
COPY requirements.txt .

# Install from wheels (fast, no compilation!)
RUN pip install --no-cache-dir --no-index --find-links=/wheels \
    -r requirements.txt && \
    rm -rf /wheels

# Copy Django application
COPY --chown=django:django . .

# Collect static files
RUN python manage.py collectstatic --noinput

USER django

EXPOSE 8000

HEALTHCHECK CMD python -c "import requests; requests.get('http://localhost:8000')"

CMD ["gunicorn", "--bind", "0.0.0.0:8000", "myproject.wsgi:application"]
```

**Why This Works**:

```
BUILDER STAGE:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Purpose: Compile Python packages         â”‚
â”‚                                          â”‚
â”‚ Includes:                                â”‚
â”‚ - gcc (C compiler)          100 MB       â”‚
â”‚ - python3-dev               50 MB        â”‚
â”‚ - postgresql-dev            30 MB        â”‚
â”‚ - Source .tar.gz files     100 MB        â”‚
â”‚ - Compiled .whl files       50 MB âœ“      â”‚
â”‚                                          â”‚
â”‚ Total: 330 MB                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ Copy only .whl files
         
PRODUCTION STAGE:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Purpose: Run Django application          â”‚
â”‚                                          â”‚
â”‚ Includes:                                â”‚
â”‚ - python:3.11-slim base    120 MB        â”‚
â”‚ - libpq5 (runtime lib)       1 MB        â”‚
â”‚ - Installed packages        80 MB        â”‚
â”‚ - Django application         5 MB        â”‚
â”‚                                          â”‚
â”‚ Total: 206 MB                            â”‚
â”‚ (vs 536 MB without multi-stage)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Key savings:
- No gcc, make, build tools
- No source .tar.gz files
- Used pre-compiled wheels (faster install)
```

### Scenario 3: Go Microservice (Smallest Possible Image)

```dockerfile
# ============================================
# Stage 1: Build Go binary
# ============================================
FROM golang:1.21-alpine AS builder

# Install build dependencies
RUN apk add --no-cache git ca-certificates tzdata

WORKDIR /build

# Download Go modules (cached layer)
COPY go.mod go.sum ./
RUN go mod download
RUN go mod verify

# Copy source code
COPY . .

# Build static binary
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
    -ldflags='-w -s -extldflags "-static"' \
    -o /app \
    ./cmd/server

# Flags explained:
# CGO_ENABLED=0: No C dependencies
# -w: Omit DWARF symbol table
# -s: Omit symbol table
# -extldflags "-static": Create fully static binary

# ============================================
# Stage 2: Absolute minimal image
# ============================================
FROM scratch

# Copy SSL certificates (for HTTPS)
COPY --from=builder /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/

# Copy timezone data (if app uses timezones)
COPY --from=builder /usr/share/zoneinfo /usr/share/zoneinfo

# Copy the binary
COPY --from=builder /app /app

# Expose port
EXPOSE 8080

# Run binary
ENTRYPOINT ["/app"]
```

**Why This Is the Smallest**:

```
BUILDER STAGE (golang:1.21-alpine):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Alpine base + Go toolchain   300 MB      â”‚
â”‚ Source code                    1 MB      â”‚
â”‚ Dependencies downloaded        5 MB      â”‚
â”‚ Compiled binary                8 MB âœ“    â”‚
â”‚                                          â”‚
â”‚ Total: 314 MB                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ Copy only binary + certs
         
PRODUCTION STAGE (scratch):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Base image (scratch)           0 MB      â”‚
â”‚ SSL certificates             0.2 MB      â”‚
â”‚ Timezone data                  1 MB      â”‚
â”‚ Go binary (static)             8 MB      â”‚
â”‚                                          â”‚
â”‚ Total: 9.2 MB                            â”‚
â”‚                                          â”‚
â”‚ This is THE SMALLEST possible!           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Comparison:
- Without multi-stage: 314 MB
- With multi-stage:    9.2 MB
- Reduction: 97% smaller!

Benefits:
- Blazing fast deploys (9 MB download)
- Minimal attack surface (no OS, no shell)
- Maximum security (only your binary)
```

---

## Summary

Multi-stage builds reduce image size by:

1. **Separating Build and Runtime**: Build with all tools, run with only necessities
2. **Different Base Images**: Use large images for building, small for production
3. **Selective Copying**: Copy only built artifacts, not source or build tools
4. **Production-Only Dependencies**: Install only runtime dependencies in final stage
5. **Layer Optimization**: Intermediate stages and their large layers are discarded

**Key Principles**:

- Build stage = temporary, gets deleted
- Production stage = final, stays in image
- COPY --from = magic that connects stages
- Only the last stage matters for final image size
- Each stage can use different base images

**Typical Reductions**:

- JavaScript/TypeScript: 80-95% smaller
- Python: 60-80% smaller
- Go: 95-99% smaller
- Java: 70-85% smaller

The beauty of multi-stage builds is you get the best of both worlds: full-featured build environment + minimal production image!